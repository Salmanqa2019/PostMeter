<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PostMeter — API Load & Stress Tester</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ----- Design system: 4px grid, spacing scale ----- */
    :root {
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      --space-12: 48px;
      --radius-sm: 6px;
      --radius: 8px;
      --radius-lg: 10px;
      --radius-xl: 12px;
      /* Theme: deep slate + teal */
      --bg: #0f1219;
      --bg-elevated: #151a24;
      --surface: #1a1f2a;
      --surface2: #222936;
      --surface-hover: #2a3142;
      --border: #2d3548;
      --border-focus: #3d4a5c;
      --text: #e8ecf4;
      --text-secondary: #a8b2c4;
      --text-muted: #6b7690;
      --accent: #14b8a6;
      --accent-hover: #2dd4bf;
      --accent-muted: rgba(20, 184, 166, 0.18);
      --accent-dim: #0d9488;
      --danger: #f87171;
      --danger-muted: rgba(248, 113, 113, 0.18);
      --warn: #fbbf24;
      --warn-muted: rgba(251, 191, 36, 0.18);
      --success: #34d399;
      --info: #38bdf8;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.24);
      --shadow: 0 4px 16px rgba(0,0,0,0.32);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
      --transition: 0.2s ease;
      /* Aliases for existing selectors */
      --textMuted: var(--text-muted);
      --accentDim: var(--accent-dim);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { -webkit-font-smoothing: antialiased; }
    body {
      font-family: 'Plus Jakarta Sans', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      font-size: 15px;
      line-height: 1.5;
    }

    .app {
      --sidebar-width: 320px;
      --header-h: 56px;
      --left-bar-w: 56px;
      display: grid;
      grid-template-columns: var(--left-bar-w) 1fr minmax(260px, var(--sidebar-width));
      grid-template-rows: var(--header-h) 1fr;
      min-height: 100vh;
    }

    header {
      grid-column: 1 / -1;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 var(--space-4);
      gap: var(--space-4);
      min-height: var(--header-h);
    }
    header .logo {
      font-size: 1.125rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dim) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      white-space: nowrap;
    }
    header .search-wrap {
      flex: 1;
      max-width: 400px;
      position: relative;
    }
    header .search-wrap input {
      width: 100%;
      height: 40px;
      padding: 0 var(--space-3) 0 36px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text);
      font-size: 0.875rem;
      font-family: inherit;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    header .search-wrap input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-muted);
    }
    header .search-wrap input::placeholder { color: var(--text-muted); }
    header .search-wrap::before {
      content: '⌕';
      position: absolute;
      left: var(--space-3);
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 0.875rem;
    }
    .header-collections-btn {
      display: none;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: var(--radius);
      background: var(--surface2);
      color: var(--text);
      font-size: 1.25rem;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      transition: background var(--transition);
    }
    .header-collections-btn:hover { background: var(--surface-hover); }
    header .env-dropdown { position: relative; }
    header .env-dropdown-btn {
      height: 40px;
      padding: 0 var(--space-3);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text-secondary);
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: var(--space-2);
      transition: border-color var(--transition), color var(--transition);
    }
    header .env-dropdown-btn:hover { border-color: var(--border-focus); color: var(--text); }
    header .env-panel-drop {
      display: none;
      position: absolute;
      top: calc(100% + var(--space-2));
      right: 0;
      min-width: 320px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      z-index: 50;
      box-shadow: var(--shadow-lg);
    }
    header .env-panel-drop.open { display: block; }
    header .env-panel-drop .field-row { margin-bottom: var(--space-3); }
    header .env-panel-drop label { font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: var(--space-1); font-weight: 500; }
    header .env-panel-drop input { width: 100%; height: 36px; padding: 0 var(--space-2); border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 0.8125rem; }

    .left-bar {
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: var(--space-2) 0;
      gap: var(--space-1);
    }
    .left-bar .icon-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      border-radius: var(--radius);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.125rem;
      transition: background var(--transition), color var(--transition);
    }
    .left-bar .icon-btn:hover { background: var(--surface-hover); color: var(--text); }
    .left-bar .icon-btn.active { background: var(--accent-muted); color: var(--accent); }

    .center {
      display: flex;
      flex-direction: column;
      min-height: 0;
      position: relative;
    }
    .center-resize {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 8px;
      cursor: col-resize;
      z-index: 5;
      background: transparent;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .center-resize:hover,
    .center-resize:active { 
      background: var(--accent-muted); 
      width: 12px;
    }
    .center-resize .resize-indicator {
      position: absolute;
      right: 2px;
      color: var(--text-muted);
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
      writing-mode: vertical-rl;
      text-orientation: mixed;
    }
    .center-resize:hover .resize-indicator {
      opacity: 1;
    }
    .editor-bar {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-4);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .editor-bar .method-select {
      height: 40px;
      padding: 0 var(--space-3);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text);
      font-weight: 600;
      font-size: 0.8125rem;
      cursor: pointer;
      min-width: 100px;
      font-family: 'JetBrains Mono', monospace;
      transition: border-color var(--transition);
    }
    .editor-bar .method-select:focus { outline: none; border-color: var(--accent); }
    .editor-bar .url-input {
      flex: 1;
      min-width: 180px;
      height: 40px;
      padding: 0 var(--space-3);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.875rem;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .editor-bar .url-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-muted); }
    .editor-bar .btn-send {
      height: 40px;
      padding: 0 var(--space-5);
      border-radius: var(--radius);
      border: none;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dim) 100%);
      color: #0f1219;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: filter var(--transition), transform var(--transition);
    }
    .editor-bar .btn-send:hover { filter: brightness(1.08); }
    .editor-bar .btn-send:active { transform: scale(0.98); }
    .editor-bar .btn-save {
      height: 40px;
      padding: 0 var(--space-4);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: border-color var(--transition), color var(--transition);
    }
    .editor-bar .btn-save:hover { border-color: var(--accent); color: var(--accent); }
    .request-tabs-bar {
      display: flex;
      align-items: center;
      min-height: 40px;
      padding: 0 var(--space-2);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
    }
    .request-tabs-list { display: flex; align-items: center; gap: 2px; min-width: 0; flex: 1; }
    .request-tab {
      display: inline-flex; align-items: center; gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      font-size: 0.8125rem; color: var(--text-secondary);
      background: var(--surface2);
      border: 1px solid transparent;
      border-bottom: none;
      border-radius: var(--radius-sm) var(--radius-sm) 0 0;
      cursor: pointer;
      max-width: 180px; min-width: 0;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      transition: background var(--transition), color var(--transition);
    }
    .request-tab:hover { color: var(--text); background: var(--surface-hover); }
    .request-tab.active { background: var(--bg-elevated); color: var(--accent); border-color: var(--border); }
    .request-tab .tab-close { padding: 0 2px; opacity: 0.6; font-size: 1rem; line-height: 1; }
    .request-tab .tab-close:hover { opacity: 1; color: var(--danger); }
    .tree-folder .folder-name.editable, .tree-item.request .req-name.editable { cursor: text; }
    .tree-folder .folder-name input.inline-edit, .tree-item.request .req-name input.inline-edit {
      width: 100%; min-width: 80px; padding: 2px 6px; font-size: inherit; font-family: inherit;
      background: var(--bg); color: var(--text); border: 1px solid var(--accent); border-radius: var(--radius-sm);
      outline: none;
    }
    .editor-tabs {
      display: flex;
      gap: 0;
      padding: var(--space-2) var(--space-4);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      align-items: center;
      flex-wrap: wrap;
    }
    .editor-tabs .etab {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-muted);
      background: transparent;
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      cursor: pointer;
      white-space: nowrap;
      transition: color var(--transition), background var(--transition), border-color var(--transition);
      margin-right: var(--space-2);
    }
    .editor-tabs .etab::before {
      content: '';
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: var(--surface2);
      flex-shrink: 0;
      transition: border-color var(--transition), background var(--transition), box-shadow var(--transition);
    }
    .editor-tabs .etab:hover { color: var(--text-secondary); }
    .editor-tabs .etab.active { color: var(--accent); border-color: var(--accent); }
    .editor-tabs .etab.active::before {
      border-color: var(--accent);
      background: var(--accent);
      box-shadow: inset 0 0 0 2px var(--surface);
    }
    .editor-tab-content .editor-tab-placeholder {
      color: var(--text-muted);
      font-size: 0.875rem;
      padding: var(--space-6);
      text-align: center;
    }
    .editor-tab-content {
      padding: var(--space-4);
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
      min-height: 120px;
    }
    .editor-tab-content .params-table { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
    .editor-tab-content .params-table th, .editor-tab-content .params-table td { padding: var(--space-2) var(--space-3); text-align: left; border-bottom: 1px solid var(--border); }
    .editor-tab-content .params-table th { color: var(--text-muted); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.04em; }
    .editor-tab-content .params-table input { width: 100%; height: 36px; padding: 0 var(--space-2); border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); font-size: 0.8125rem; }
    .editor-tab-content .params-table .btn-row-del { width: 36px; min-width: 36px; height: 36px; padding: 0; border: none; border-radius: var(--radius-sm); background: transparent; color: var(--text-muted); cursor: pointer; font-size: 1rem; line-height: 1; transition: color var(--transition); }
    .editor-tab-content .params-table .btn-row-del:hover { color: var(--danger); }
    .editor-tab-content .params-table-wrap { display: flex; flex-direction: column; gap: var(--space-3); }
    .editor-tab-content .btn-add-row { display: inline-flex; align-items: center; gap: var(--space-2); padding: var(--space-2) var(--space-3); border: 1px dashed var(--border); border-radius: var(--radius); background: transparent; color: var(--text-muted); font-size: 0.8125rem; font-weight: 500; cursor: pointer; transition: all var(--transition); }
    .editor-tab-content .btn-add-row:hover { border-color: var(--accent); color: var(--accent); }
    .editor-tab-content .auth-form label { display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 600; margin-bottom: var(--space-1); }
    .editor-tab-content .auth-form .field { margin-bottom: var(--space-4); }
    .editor-tab-content .auth-form select, .editor-tab-content .auth-form input[type="text"], .editor-tab-content .auth-form input[type="password"] { width: 100%; max-width: 320px; height: 36px; padding: 0 var(--space-2); border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); font-size: 0.8125rem; }
    .var-highlight { color: var(--info); font-weight: 500; }
    .load-test-bar {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .load-test-bar { align-items: center; }
    .load-test-hint { font-size: 0.7rem; color: var(--text-muted); margin-left: var(--space-2); max-width: 420px; }
    .load-test-bar label { font-size: 0.75rem; color: var(--text-muted); margin-right: var(--space-1); font-weight: 500; }
    .load-test-bar input[type="number"] { width: 72px; height: 36px; padding: 0 var(--space-2); border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 0.8125rem; }
    .load-test-bar .sla-inline { display: inline-flex; align-items: center; gap: var(--space-1); }
    .load-test-bar .sla-inline input { width: 52px; }
    .sla-badge { display: inline-block; padding: 2px 8px; border-radius: var(--radius-sm); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; margin-left: var(--space-2); }
    .sla-badge.pass { background: var(--success); color: var(--bg); }
    .sla-badge.fail { background: var(--danger); color: var(--bg); }
    .load-test-user-data { padding: var(--space-3) var(--space-4); background: var(--surface); border-bottom: 1px solid var(--border); }
    .user-data-drop-paste { border: 2px dashed var(--border); border-radius: var(--radius); padding: var(--space-2); transition: border-color var(--transition), background var(--transition); }
    .user-data-drop-paste.drag-over { border-color: var(--accent); background: var(--accent-muted); }
    .user-data-drop-paste .user-data-paste { width: 100%; min-height: 64px; padding: var(--space-2); border: none; border-radius: var(--radius-sm); background: var(--bg); color: var(--text); font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; resize: vertical; display: block; margin-bottom: var(--space-2); }
    .user-data-drop-paste .user-data-paste::placeholder { color: var(--text-muted); }
    .user-data-drop-paste .user-data-actions { display: flex; align-items: center; gap: var(--space-2); flex-wrap: wrap; }
    .user-data-drop-paste .user-data-count { font-size: 0.8125rem; font-weight: 600; color: var(--accent); }
    .btn-sm { padding: var(--space-1) var(--space-2); font-size: 0.75rem; }
    .runner-output-wrap { background: var(--surface2); border-bottom: 1px solid var(--border); max-height: 360px; display: flex; flex-direction: column; }
    .runner-output-head { display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) var(--space-4); background: var(--surface); border-bottom: 1px solid var(--border); }
    .runner-output-title { font-weight: 600; font-size: 0.875rem; }
    .runner-output-meta { color: var(--text-muted); font-size: 0.8125rem; flex: 1; }
    .runner-output-list { overflow: auto; padding: var(--space-2); }
    .runner-item { border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: var(--space-2); overflow: hidden; }
    .runner-item-head { display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) var(--space-3); cursor: pointer; background: var(--surface); transition: background var(--transition); }
    .runner-item-head:hover { background: var(--surface-hover); }
    .runner-item-head .method { font-size: 0.7rem; font-weight: 700; padding: 2px 6px; border-radius: 4px; }
    .runner-item-head .method.GET { background: var(--success); color: var(--bg); }
    .runner-item-head .method.POST { background: var(--info); color: var(--bg); }
    .runner-item-head .method.PUT { background: var(--warn); color: var(--bg); }
    .runner-item-head .method.DELETE { background: var(--danger); color: var(--bg); }
    .runner-item-head .method.PATCH { background: var(--accent); color: var(--bg); }
    .runner-item-head .name { flex: 1; font-size: 0.8125rem; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .runner-item-head .status { font-size: 0.75rem; font-weight: 600; }
    .runner-item-head .status.ok { color: var(--success); }
    .runner-item-head .status.err { color: var(--danger); }
    .runner-item-head .time { font-size: 0.75rem; color: var(--text-muted); }
    .runner-item-head .chevron { font-size: 0.75rem; color: var(--text-muted); transition: transform var(--transition); }
    .runner-item.expanded .chevron { transform: rotate(90deg); }
    .runner-item-body { display: none; padding: var(--space-2); background: var(--bg); border-top: 1px solid var(--border); max-height: 200px; overflow: auto; }
    .runner-item.expanded .runner-item-body { display: block; }
    .runner-item-body pre { margin: 0; font-size: 0.75rem; white-space: pre-wrap; word-break: break-all; }
    .load-test-bar .mode-tabs { display: flex; gap: var(--space-1); }
    .load-test-bar .mode-tabs button { height: 36px; padding: 0 var(--space-3); border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--surface2); color: var(--text-muted); font-size: 0.8125rem; font-weight: 500; cursor: pointer; transition: all var(--transition); }
    .load-test-bar .mode-tabs button.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
    .response-panel {
      background: var(--surface2);
      border-top: 1px solid var(--border);
      padding: var(--space-3) var(--space-4);
      min-height: 80px;
    }
    .response-panel .res-head { font-size: 0.8125rem; color: var(--text-muted); margin-bottom: var(--space-2); display: flex; gap: var(--space-4); align-items: center; }
    .response-panel .res-status { font-weight: 600; }
    .response-panel .res-status.ok { color: var(--success); }
    .response-panel .res-status.err { color: var(--danger); }
    .response-panel .res-body {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8125rem;
      line-height: 1.6;
      white-space: pre;
      word-break: break-word;
      max-height: 320px;
      overflow: auto;
      padding: var(--space-3);
      border-radius: var(--radius);
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      tab-size: 2;
    }

    .sidebar-wrap {
      position: relative;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .sidebar-resize {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 8px;
      cursor: col-resize;
      z-index: 5;
      background: transparent;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .sidebar-resize:hover,
    .sidebar-resize:active { 
      background: var(--accent-muted); 
      width: 12px;
    }
    .resize-indicator {
      position: absolute;
      right: 2px;
      color: var(--text-muted);
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
      writing-mode: vertical-rl;
      text-orientation: mixed;
    }
    .sidebar-resize:hover .resize-indicator {
      opacity: 1;
    }
    .sidebar {
      background: var(--surface);
      border-left: 1px solid var(--border);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0;
      flex: 1;
      min-width: 0;
    }
    .sidebar .head {
      padding: var(--space-3) var(--space-4);
      font-size: 0.6875rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-2);
      flex-wrap: wrap;
    }
    .sidebar .head-btns { display: flex; gap: var(--space-1); flex-wrap: wrap; }
    .sidebar .head-btns button {
      height: 32px;
      padding: 0 var(--space-2);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text-muted);
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: border-color var(--transition), color var(--transition);
    }
    .sidebar .head-btns button:hover { color: var(--accent); border-color: var(--accent); }
    .tree {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 0 var(--space-2) var(--space-4);
    }
    .tree-group { margin-bottom: var(--space-1); }
    .tree-group.collapsed .tree-children { display: none; }
    .tree-children {
      padding-left: var(--space-3);
      margin-left: var(--space-2);
      border-left: 1px solid var(--border);
      transition: opacity var(--transition);
    }
    .tree-folder {
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-weight: 600;
      color: var(--text);
      user-select: none;
      min-height: 40px;
      transition: background var(--transition);
    }
    .tree-folder:hover { background: var(--surface-hover); }
    .tree-folder .chevron {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: transform var(--transition);
      color: var(--text-muted);
      font-size: 0.7rem;
    }
    .tree-group.collapsed .tree-folder .chevron { transform: rotate(-90deg); }
    .tree-folder .folder-name {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .tree-item {
      padding: var(--space-2) var(--space-2) var(--space-2) var(--space-6);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 0.8125rem;
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-1);
      min-height: 36px;
      transition: background var(--transition);
    }
    .tree-item:hover { background: var(--surface-hover); }
    .tree-item.folder { font-weight: 600; color: var(--text); }
    .tree-item.request { font-weight: 400; color: var(--text-secondary); }
    .tree-item.request.selected { background: var(--accent-muted); color: var(--accent); }
    .tree-item input[type="checkbox"] { margin-right: var(--space-1); accent-color: var(--accent); }
    .tree-item .req-name {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .tree-item .method {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.6875rem;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      min-width: 36px;
      text-align: center;
    }
    .method.GET { background: var(--accent-muted); color: var(--accent); }
    .method.POST { background: var(--warn-muted); color: var(--warn); }
    .method.PUT { background: rgba(56, 189, 248, 0.2); color: var(--info); }
    .method.DELETE { background: var(--danger-muted); color: var(--danger); }
    .method.PATCH { background: rgba(167, 139, 250, 0.2); color: #a78bfa; }

    .main {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .panel {
      background: var(--surface2);
      margin: var(--space-4);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    .panel-title {
      padding: var(--space-3) var(--space-4);
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text);
      border-bottom: 1px solid var(--border);
    }
    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: var(--space-4);
      padding: var(--space-4);
    }
    .field label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: var(--space-2);
      font-weight: 500;
    }
    .field input, .field select {
      width: 100%;
      height: 40px;
      padding: 0 var(--space-3);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8125rem;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .field input:focus, .field select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-muted);
    }
    .mode-tabs {
      display: flex;
      gap: var(--space-1);
      padding: var(--space-4) var(--space-4) 0;
    }
    .mode-tabs button {
      height: 40px;
      padding: 0 var(--space-4);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-muted);
      font-family: inherit;
      font-weight: 500;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all var(--transition);
    }
    .mode-tabs button:hover { color: var(--text); border-color: var(--border-focus); }
    .mode-tabs button.active {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }
    .actions {
      padding: var(--space-4);
      display: flex;
      gap: var(--space-3);
      align-items: center;
      flex-wrap: wrap;
    }
    .btn {
      min-height: 40px;
      padding: 0 var(--space-6);
      border-radius: var(--radius);
      font-family: inherit;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      border: none;
      transition: all var(--transition);
    }
    .btn-run {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dim) 100%);
      color: var(--bg);
    }
    .btn-run:hover { filter: brightness(1.08); transform: translateY(-1px); }
    .btn-run:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-run.running { animation: pulse 1s ease infinite; }
    @keyframes pulse { 50% { opacity: 0.85; } }
    .btn-export {
      background: var(--surface2);
      color: var(--accent);
      border: 1px solid var(--accent);
    }
    .btn-export:hover { background: var(--accent-muted); }
    .status-msg { font-size: 0.875rem; color: var(--text-muted); }
    .status-msg.success { color: var(--success); }
    .status-msg.error { color: var(--danger); }

    .report {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding: var(--space-6);
      max-width: 1200px;
      margin: 0 auto;
    }
    .live-results-wrap {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: var(--space-4);
      margin-bottom: var(--space-6);
    }
    .live-results-title { font-size: 1rem; margin: 0 0 var(--space-3) 0; color: var(--text); }
    .live-results-count { font-weight: 600; color: var(--accent); }
    .live-results-table-wrap { max-height: 320px; overflow-y: auto; }
    .live-results-table { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
    .live-results-table th, .live-results-table td { padding: var(--space-2) var(--space-3); text-align: left; border-bottom: 1px solid var(--border); }
    .live-results-table th { background: var(--bg); color: var(--text-muted); font-weight: 600; }
    .live-results-table tr.success td:nth-child(3) { color: var(--success); }
    .live-results-table tr.failed td:nth-child(3) { color: var(--danger); }
    .live-results-table .response-preview { max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-family: monospace; font-size: 0.75rem; }
    .report-cover {
      background: linear-gradient(160deg, var(--surface2) 0%, var(--bg) 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: var(--space-10) var(--space-6);
      margin-bottom: var(--space-6);
      text-align: center;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    .report-cover::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--accent-dim));
    }
    .report-cover .report-product { font-size: 0.6875rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); margin-bottom: var(--space-2); }
    .report-cover .report-doc-title { font-size: 1.75rem; font-weight: 700; color: var(--text); letter-spacing: -0.02em; margin-bottom: var(--space-1); }
    .report-cover .report-doc-sub { font-size: 0.9375rem; color: var(--text-muted); margin-bottom: var(--space-6); }
    .report-cover .report-date { font-size: 0.8125rem; color: var(--accent); font-family: 'JetBrains Mono', monospace; }
    .report-section {
      background: var(--surface2);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border);
      margin-bottom: var(--space-6);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }
    .report-section h3 {
      padding: var(--space-4) var(--space-6);
      font-size: 0.75rem;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: var(--bg-elevated);
    }
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: var(--space-4);
      padding: var(--space-6);
    }
    .stat-card {
      background: var(--bg);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .stat-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--accent);
    }
    .stat-card.danger::before { background: var(--danger); }
    .stat-card.warn::before { background: var(--warn); }
    .stat-card .value { font-size: 1.5rem; font-weight: 700; color: var(--accent); font-family: 'JetBrains Mono', monospace; letter-spacing: -0.02em; }
    .stat-card .label { font-size: 0.6875rem; color: var(--text-muted); margin-top: var(--space-2); line-height: 1.3; text-transform: uppercase; letter-spacing: 0.05em; }
    .stat-card.danger .value { color: var(--danger); }
    .stat-card.warn .value { color: var(--warn); }
    .chart-wrap { padding: var(--space-6); }
    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: var(--space-6); padding: var(--space-6); }
    .chart-box {
      background: var(--bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: var(--space-5);
      box-shadow: var(--shadow-sm);
    }
    .chart-box h4 {
      margin: 0 0 var(--space-4) 0;
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      padding-bottom: var(--space-2);
      border-bottom: 1px solid var(--border);
    }
    .chart-box canvas { max-height: 240px; display: block; }
    .report-header { padding: var(--space-6); border-bottom: 1px solid var(--border); display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: var(--space-4); background: var(--bg-elevated); }
    .report-title { font-size: 1.3125rem; font-weight: 700; color: var(--text); letter-spacing: -0.02em; }
    .report-meta { font-size: 0.8125rem; color: var(--text-muted); }
    .executive-summary {
      padding: var(--space-6) var(--space-8);
      margin: var(--space-6);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      border-left: 4px solid var(--accent);
      background: var(--accent-muted);
    }
    .executive-summary .exec-label { font-size: 0.6875rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent); font-weight: 600; margin-bottom: var(--space-2); }
    .executive-summary p { margin: 0 0 var(--space-2) 0; font-size: 0.9375rem; line-height: 1.6; color: var(--text); }
    .executive-summary p:last-child { margin-bottom: 0; font-size: 0.875rem; color: var(--text-muted); }
    .error-breakdown-list { padding: var(--space-5) var(--space-6); font-size: 0.875rem; }
    .error-breakdown-list li { margin-bottom: var(--space-2); color: var(--danger); padding-left: var(--space-3); border-left: 2px solid var(--danger); margin-left: var(--space-2); }
    .error-breakdown-list .count { color: var(--text-muted); margin-left: var(--space-2); font-weight: 600; }
    .report-footer {
      text-align: center;
      padding: var(--space-5) var(--space-6);
      font-size: 0.75rem;
      color: var(--text-muted);
      border-top: 1px solid var(--border);
      margin-top: var(--space-2);
    }
    .report-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-6); padding: 0 var(--space-6) var(--space-6); }
    .report-config, .report-findings {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-4) var(--space-5);
    }
    .report-config h4, .report-findings h4 { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin: 0 0 var(--space-3) 0; }
    .report-config dl, .report-findings ul { margin: 0; padding: 0; list-style: none; }
    .report-config dt { font-size: 0.75rem; color: var(--text-muted); margin-top: var(--space-2); }
    .report-config dt:first-child { margin-top: 0; }
    .report-config dd { font-size: 0.875rem; font-family: 'JetBrains Mono', monospace; color: var(--text); margin: 2px 0 0 0; }
    .report-findings li { font-size: 0.875rem; color: var(--text); margin-bottom: var(--space-2); padding-left: var(--space-4); position: relative; }
    .report-findings li::before { content: '•'; position: absolute; left: 0; color: var(--accent); font-weight: bold; }
    .report-findings li.fail { color: var(--danger); }
    .report-findings li.fail::before { color: var(--danger); }
    .auth-workspace-bar { display: flex; align-items: center; flex-wrap: wrap; gap: var(--space-2); margin-left: auto; }
    .auth-workspace-bar .auth-logged { display: flex; align-items: center; flex-wrap: wrap; gap: var(--space-2); }
    .auth-workspace-bar .workspace-select { min-width: 140px; padding: 6px 10px; border-radius: var(--radius); border: 1px solid var(--border); background: var(--surface2); color: var(--text); font-size: 0.8125rem; }
    .auth-workspace-bar .user-email { font-size: 0.8125rem; color: var(--text-muted); max-width: 160px; overflow: hidden; text-overflow: ellipsis; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .modal-box { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-xl); padding: 24px; min-width: 280px; max-width: 400px; position: relative; }
    .modal-box .modal-close { position: absolute; top: 12px; right: 12px; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; padding: 4px; }
    .modal-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
    .modal-tab { padding: 8px 16px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; border-radius: var(--radius); }
    .modal-tab.active { background: var(--accent-muted); color: var(--accent); }
    .modal-input { width: 100%; padding: 10px 12px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg); color: var(--text); font-size: 0.9375rem; box-sizing: border-box; }
    .auth-error { color: var(--danger); font-size: 0.875rem; margin-bottom: 8px; min-height: 20px; }
    .share-title { margin: 0 0 8px 0; font-size: 1rem; }
    .share-desc { font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 12px; }
    .share-members-list { list-style: none; margin: 12px 0 0 0; padding: 0; font-size: 0.875rem; }
    .share-members-list li { padding: 6px 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-actions { display: flex; gap: var(--space-3); justify-content: flex-end; margin-top: var(--space-4); }
    .btn-danger-outline { color: var(--danger); border-color: var(--danger); }
    .btn-danger-outline:hover { background: var(--danger-muted); }
    @media print {
      body * { visibility: hidden; }
      .report, .report * { visibility: visible; }
      .report { position: absolute; left: 0; top: 0; width: 100%; max-width: none; padding: 24px; overflow: visible; background: #fff; }
      .report-cover { background: #f8fafc; border: 1px solid #e2e8f0; }
      .report-section { break-inside: avoid; box-shadow: none; border: 1px solid #e2e8f0; }
      .report-header, .executive-summary, .stats-cards, .charts-grid, .chart-box canvas { visibility: visible; }
      .left-bar, header, .sidebar, .editor-bar, .load-test-bar, .response-panel, .editor-tabs, .editor-tab-content, .empty-state { display: none !important; }
      .center { margin: 0; max-width: none; }
      .stat-card .value { color: #0d9488; }
      .stat-card.danger .value { color: #dc2626; }
      .report-footer { border-top-color: #e2e8f0; color: #64748b; }
    }
    .per-request-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    .per-request-table th, .per-request-table td {
      padding: var(--space-3) var(--space-5);
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .per-request-table thead { background: var(--bg-elevated); }
    .per-request-table th {
      color: var(--text-muted);
      font-weight: 600;
      font-size: 0.6875rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .per-request-table tbody tr:hover { background: var(--surface-hover); }
    .per-request-table tbody tr:nth-child(even) { background: rgba(0,0,0,0.06); }
    .per-request-table tbody tr:nth-child(even):hover { background: var(--surface-hover); }
    .empty-state {
      text-align: center;
      padding: var(--space-12) var(--space-6);
      color: var(--text-muted);
      font-size: 0.9375rem;
      line-height: 1.6;
    }
    .empty-state svg { width: 64px; height: 64px; margin-bottom: var(--space-4); opacity: 0.5; }
    .loading { display: inline-block; width: 18px; height: 18px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: var(--space-2); vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.65); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 100; padding: var(--space-4);
    }
    .modal {
      background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); min-width: 380px; max-width: 90vw; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg);
    }
    .modal .modal-head { padding: var(--space-4) var(--space-5); border-bottom: 1px solid var(--border); font-weight: 600; font-size: 1rem; display: flex; justify-content: space-between; align-items: center; }
    .modal .modal-body { padding: var(--space-5); }
    .modal .modal-foot { padding: var(--space-3) var(--space-5); border-top: 1px solid var(--border); display: flex; gap: var(--space-2); justify-content: flex-end; }
    .modal-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.25rem; padding: 0 var(--space-2); line-height: 1; }
    .modal-close:hover { color: var(--text); }
    .field-row { margin-bottom: var(--space-3); }
    .field-row label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: var(--space-1); font-weight: 500; }
    .field-row input, .field-row select, .field-row textarea {
      width: 100%; min-height: 40px; padding: 0 var(--space-3); border-radius: var(--radius); border: 1px solid var(--border); background: var(--bg); color: var(--text); font-family: 'JetBrains Mono', monospace; font-size: 0.8125rem;
    }
    .field-row textarea { min-height: 80px; padding: var(--space-2) var(--space-3); }
    .btn-sm { min-height: 36px; padding: 0 var(--space-4); font-size: 0.875rem; }
    .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
    .btn-ghost:hover { color: var(--text); border-color: var(--border-focus); }
    #importFile { display: none; }
    .env-panel {
      padding: var(--space-3);
      border-bottom: 1px solid var(--border);
      background: var(--surface2);
    }
    .env-panel-title { font-size: 0.6875rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: var(--space-2); font-weight: 600; }
    .env-panel .field-row { margin-bottom: var(--space-2); }
    .env-panel .field-row:last-of-type { margin-bottom: var(--space-2); }
    .env-panel input { width: 100%; height: 36px; padding: 0 var(--space-2); font-size: 0.8125rem; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--bg); color: var(--text); font-family: 'JetBrains Mono', monospace; }
    .env-note { font-size: 0.75rem; color: var(--text-muted); margin-top: var(--space-2); line-height: 1.4; }
    .collection-vars-list { max-height: 200px; overflow-y: auto; margin-top: var(--space-2); }
    .collection-vars-list .coll-block { padding: var(--space-3); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: var(--space-2); background: var(--bg); }
    .collection-vars-list .coll-block .coll-name { font-size: 0.75rem; font-weight: 600; color: var(--accent); margin-bottom: var(--space-2); }
    .collection-vars-list .coll-block .field-row { margin-bottom: var(--space-2); }
    .tree-item .pad { margin-left: var(--space-1); }
    .apis-list-wrap { max-height: 240px; overflow-y: auto; padding: var(--space-3) var(--space-4); }
    .apis-list-wrap .api-line { font-size: 0.8125rem; padding: var(--space-1) 0; display: flex; align-items: center; gap: var(--space-2); color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
    .apis-list-wrap .api-line .m { font-size: 0.625rem; padding: 2px 5px; border-radius: 4px; min-width: 32px; text-align: center; font-weight: 600; }
    .sidebar .head-btns .btn-add { color: var(--accent); border-color: var(--accent); }
    .sidebar .head-btns .btn-add:hover { background: var(--accent-muted); }
    .sidebar .head-btns .btn-expand-sidebar { font-size: 0.7rem; }
    .sidebar-wrap.expanded { --sidebar-expanded-width: min(520px, 45vw); }
    .sidebar-wrap.expanded .sidebar-resize { right: 0; }
.tree-folder .tree-actions, .tree-item.request .tree-actions { opacity: 0; margin-left: auto; flex-shrink: 0; display: flex; gap: var(--space-1); align-items: center; }
.tree-folder:hover .tree-actions, .tree-item.request:hover .tree-actions, .tree-item.request.selected .tree-actions { opacity: 1; }
.btn-run-folder { padding: 2px 8px; font-size: 0.7rem; border-radius: 4px; border: 1px solid var(--accent); background: var(--accent-muted); color: var(--accent); cursor: pointer; font-weight: 600; }
.btn-run-folder:hover { background: var(--accent); color: var(--bg); }
    .tree-actions button { min-height: 28px; padding: 0 var(--space-2); background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.8125rem; border-radius: var(--radius-sm); transition: color var(--transition), background var(--transition); }
    .tree-actions button:hover { color: var(--accent); background: var(--surface-hover); }
    .tree-actions button.danger:hover { color: var(--danger); }
    .tree-actions button.btn-add-req-to-col { color: var(--accent); font-size: 0.75rem; }
    .tree-actions button.btn-add-req-to-col:hover { background: var(--accent-muted); color: var(--accent); }
    .tree-folder, .tree-item.request { display: flex; align-items: center; }
    .tree-folder > span:first-of-type, .tree-item.request > span:first-of-type { flex: 0 0 auto; }
    .tree-folder > span:nth-child(2), .tree-item.request .method { flex: 0 0 auto; }
    .tree-folder > span:last-of-type:not(.tree-actions), .tree-item.request .req-name { flex: 1; min-width: 0; }
    .context-menu { position: fixed; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow-lg); z-index: 1000; min-width: 180px; padding: var(--space-1) 0; }
    .context-menu button { display: block; width: 100%; text-align: left; padding: var(--space-2) var(--space-4); border: none; background: none; color: var(--text); cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: background var(--transition); }
    .context-menu button:hover { background: var(--surface-hover); }
    .context-menu button.danger { color: var(--danger); }

    /* ----- Responsive ----- */
    @media (max-width: 1024px) {
      .header-collections-btn { display: flex; }
      .app {
        grid-template-columns: var(--left-bar-w) 1fr;
      }
      .sidebar-wrap {
        position: fixed;
        top: var(--header-h);
        right: 0;
        bottom: 0;
        width: min(360px, 90vw);
        z-index: 60;
        transform: translateX(100%);
        transition: transform 0.25s ease;
        box-shadow: -8px 0 24px rgba(0,0,0,0.3);
      }
      .sidebar-wrap.open {
        transform: translateX(0);
      }
      .sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.45);
        z-index: 55;
        top: var(--header-h);
      }
      .sidebar-overlay.open { display: block; }
      .sidebar-resize { display: none; }
    }
    @media (max-width: 768px) {
      .app {
        grid-template-columns: 1fr;
        grid-template-rows: var(--header-h) 1fr;
      }
      header {
        flex-wrap: wrap;
        padding: var(--space-2) var(--space-3);
        gap: var(--space-2);
      }
      header .search-wrap { max-width: 100%; order: 3; width: 100%; }
      .left-bar {
        position: fixed;
        left: 0;
        bottom: 0;
        top: auto;
        width: 100%;
        flex-direction: row;
        justify-content: center;
        padding: var(--space-2);
        border-right: none;
        border-top: 1px solid var(--border);
        z-index: 50;
        background: var(--surface);
      }
      .center {
        grid-column: 1;
        grid-row: 2;
        padding-bottom: 64px;
      }
      .editor-bar {
        flex-wrap: wrap;
        padding: var(--space-2) var(--space-3);
        gap: var(--space-2);
      }
      .editor-bar .method-select { min-width: 80px; }
      .editor-bar .url-input { min-width: 100%; }
      .editor-tabs { padding: 0 var(--space-2); }
      .editor-tabs .etab { padding: var(--space-2) var(--space-3); font-size: 0.75rem; }
      .load-test-bar {
        padding: var(--space-2) var(--space-3);
        gap: var(--space-2);
      }
      .load-test-bar input[type="number"] { width: 56px; }
      .report { padding: var(--space-4); }
      .report-cover { padding: var(--space-6) var(--space-4); }
      .report-detail-grid { grid-template-columns: 1fr; padding: 0 var(--space-4) var(--space-4); }
      .stats-cards { grid-template-columns: repeat(2, 1fr); gap: var(--space-2); padding: var(--space-4); }
      .charts-grid { grid-template-columns: 1fr; padding: var(--space-4); }
      .sidebar-wrap { width: 100%; max-width: 100%; }
    }
    @media (max-width: 480px) {
      .panel { margin: var(--space-2); }
      .config-grid { grid-template-columns: 1fr; padding: var(--space-3); }
      .actions { padding: var(--space-3); flex-direction: column; align-items: stretch; }
      .btn { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <button type="button" class="header-collections-btn" id="headerCollectionsBtn" title="Collections" aria-label="Toggle collections">☰</button>
      <span class="logo">PostMeter</span>
      <div class="search-wrap">
        <input type="text" id="searchCommands" placeholder="Search and commands" />
      </div>
      <div class="env-dropdown">
        <button type="button" class="env-dropdown-btn" id="envDropdownBtn">Select environment ▾</button>
        <div class="env-panel-drop" id="envPanelDrop">
          <div class="env-panel-title">Global (default)</div>
          <div class="field-row">
            <label>baseUrl</label>
            <input type="text" id="baseUrlEnv" placeholder="https://api.example.com" title="Replaces &lt;&lt;baseUrl&gt;&gt;" />
          </div>
          <div class="field-row">
            <label>Token (Inherit)</label>
            <input type="password" id="bearerTokenEnv" placeholder="Bearer token" autocomplete="off" />
          </div>
          <p class="env-note">Requests with auth <strong>Inherit</strong> use token from their collection or this.</p>
          <div class="env-panel-title" style="margin-top:16px;">Per collection (override)</div>
          <div id="collectionVarsList" class="collection-vars-list"></div>
        </div>
      </div>
      <div class="auth-workspace-bar" id="authWorkspaceBar">
        <div class="auth-guest" id="authGuest">
          <button type="button" class="btn btn-ghost btn-sm" id="loginBtn">Login</button>
          <button type="button" class="btn btn-run btn-sm" id="registerBtn">Register</button>
        </div>
        <div class="auth-logged" id="authLogged" style="display:none;">
          <select class="workspace-select" id="workspaceSelect" title="Current workspace (Personal = local data)">
            <option value="">Personal workspace</option>
          </select>
          <button type="button" class="btn btn-ghost btn-sm" id="addWorkspaceBtn" title="Add workspace">+ Workspace</button>
          <button type="button" class="btn btn-ghost btn-sm" id="shareWorkspaceBtn" title="Share this workspace">Share</button>
          <button type="button" class="btn btn-ghost btn-sm btn-danger-outline" id="deleteWorkspaceBtn" title="Delete this workspace (owner only)" style="display:none;">Delete workspace</button>
          <span class="user-email" id="userEmail"></span>
          <button type="button" class="btn btn-ghost btn-sm" id="logoutBtn">Logout</button>
        </div>
      </div>
    </header>
    <div class="modal-overlay" id="authModalOverlay" style="display:none;">
      <div class="modal-box auth-modal" id="authModal">
        <div class="modal-tabs">
          <button type="button" class="modal-tab active" data-tab="login">Login</button>
          <button type="button" class="modal-tab" data-tab="register">Register</button>
        </div>
        <div class="modal-panel" id="loginPanel">
          <input type="email" id="loginEmail" placeholder="Email" class="modal-input" />
          <input type="password" id="loginPassword" placeholder="Password" class="modal-input" />
          <p class="auth-error" id="loginError"></p>
          <button type="button" class="btn btn-run" id="loginSubmitBtn">Login</button>
        </div>
        <div class="modal-panel" id="registerPanel" style="display:none;">
          <input type="text" id="registerName" placeholder="Name (optional)" class="modal-input" />
          <input type="email" id="registerEmail" placeholder="Email" class="modal-input" />
          <input type="password" id="registerPassword" placeholder="Password (min 6)" class="modal-input" />
          <p class="auth-error" id="registerError"></p>
          <button type="button" class="btn btn-run" id="registerSubmitBtn">Register</button>
        </div>
        <button type="button" class="modal-close" id="authModalClose">✕</button>
      </div>
    </div>
    <div class="modal-overlay" id="newWorkspaceModalOverlay" style="display:none;">
      <div class="modal-box new-workspace-modal" id="newWorkspaceModal">
        <h3 class="share-title">Create workspace</h3>
        <p class="share-desc">Enter a name for your new workspace. You can add collections and requests after.</p>
        <input type="text" id="newWorkspaceName" placeholder="e.g. My Project, QA APIs" class="modal-input" maxlength="120" autocomplete="off" />
        <p class="auth-error" id="newWorkspaceError"></p>
        <div class="modal-actions">
          <button type="button" class="btn btn-ghost" id="newWorkspaceCancelBtn">Cancel</button>
          <button type="button" class="btn btn-run" id="newWorkspaceCreateBtn">Create</button>
        </div>
        <button type="button" class="modal-close" id="newWorkspaceModalClose">✕</button>
      </div>
    </div>
    <div class="modal-overlay" id="shareModalOverlay" style="display:none;">
      <div class="modal-box share-modal" id="shareModal">
        <h3 class="share-title">Share workspace</h3>
        <p class="share-desc">Invite by email. User must have an account (register first).</p>
        <input type="email" id="shareEmail" placeholder="Email to invite" class="modal-input" />
        <button type="button" class="btn btn-run" id="shareInviteBtn">Invite</button>
        <ul class="share-members-list" id="shareMembersList"></ul>
        <button type="button" class="modal-close" id="shareModalClose">✕</button>
      </div>
    </div>

    <aside class="left-bar">
      <button type="button" class="icon-btn active" title="Request">◇</button>
      <button type="button" class="icon-btn" title="Environment" id="leftEnvBtn">◐</button>
      <button type="button" class="icon-btn" title="Settings">⚙</button>
    </aside>

    <main class="center">
      <div class="center-resize" id="centerResize" title="Drag to resize">
        <div class="resize-indicator">⋮</div>
      </div>
      <div class="request-tabs-bar" id="requestTabsBar">
        <div class="request-tabs-list" id="requestTabsList"></div>
      </div>
      <div class="editor-bar">
        <select class="method-select" id="editorMethod">
          <option value="GET">GET</option>
          <option value="POST">POST</option>
          <option value="PUT">PUT</option>
          <option value="PATCH">PATCH</option>
          <option value="DELETE">DELETE</option>
        </select>
        <input type="text" class="url-input" id="editorUrl" placeholder="<<baseUrl>>/api/..." />
        <button type="button" class="btn-send" id="sendBtn">Send</button>
        <button type="button" class="btn-save" id="saveRequestBtn">Save</button>
        <button type="button" class="btn-ghost" id="duplicateRequestBtn" title="Duplicate this request">Duplicate</button>
      </div>
      <div class="editor-tabs" role="radiogroup" aria-label="Request options">
        <button type="button" class="etab" data-etab="params" role="radio" aria-checked="false">Parameters</button>
        <button type="button" class="etab" data-etab="body" role="radio" aria-checked="false">Body</button>
        <button type="button" class="etab" data-etab="headers" role="radio" aria-checked="false">Headers</button>
        <button type="button" class="etab" data-etab="auth" role="radio" aria-checked="false">Authorization</button>
      </div>
      <div class="editor-tab-content" id="editorTabContent">
        <div class="editor-tab-placeholder" id="editorTabPlaceholder">Select one: Parameters, Body, Headers or Authorization</div>
      </div>
      <div class="response-panel" id="responsePanel">
        <div class="res-head">
          <span class="res-status" id="resStatus">–</span>
          <span id="resTime"></span>
        </div>
        <pre class="res-body" id="resBody">Send a request to see response.</pre>
      </div>
      <div class="load-test-bar">
        <span class="mode-tabs">
          <button type="button" data-mode="single" class="active">Single</button>
          <button type="button" data-mode="multiple">Multiple</button>
          <button type="button" data-mode="regression">Regression</button>
        </span>
        <label title="Total runs (ignored if Run for &gt; 0)">Iterations</label>
        <input type="number" id="iterations" min="1" value="10" />
        <label>Concurrency</label>
        <input type="number" id="concurrency" min="1" value="5" />
        <label title="Run for this many seconds (0 = use Iterations)">Run for (sec)</label>
        <input type="number" id="durationSeconds" min="0" value="0" style="width:56px;" />
        <label title="Pause between each request (ms)">Delay (ms)</label>
        <input type="number" id="delayBetweenMs" min="0" value="0" style="width:56px;" />
        <label title="Gradually increase load over this many seconds (0 = no ramp-up)">Ramp-up (sec)</label>
        <input type="number" id="rampUpSeconds" min="0" value="0" style="width:56px;" />
        <label title="Split load across this many workers (same machine)">Workers</label>
        <input type="number" id="workers" min="1" max="8" value="1" style="width:48px;" />
        <span class="sla-inline" title="Pass criteria: min success rate and max p95 latency">
          <label>SLA</label>
          <input type="number" id="slaMinSuccessRate" min="0" max="100" value="0" placeholder="% success" style="width:52px;" title="Min success rate % (0 = off)" />
          <input type="number" id="slaMaxP95Ms" min="0" value="0" placeholder="p95 ms" style="width:56px;" title="Max p95 latency ms (0 = off)" />
        </span>
        <button type="button" class="btn btn-run" id="runBtn" title="Load / stress test (iterations, concurrency)">Run test</button>
        <button type="button" class="btn btn-run" id="runnerBtn" title="Pura collection run karo ya checkboxes se APIs select karke run karo — har request ka response dikhega">API Runner</button>
        <button type="button" class="btn btn-export" id="exportBtn" disabled>Export JSON</button>
        <button type="button" class="btn btn-export" id="exportHtmlBtn" disabled title="Download standalone HTML report">Export HTML report</button>
        <button type="button" class="btn btn-ghost" id="printReportBtn" disabled title="Print / Save as PDF">Print report</button>
        <span class="status-msg" id="statusMsg"></span>
        <span class="load-test-hint" id="loadTestHint">Pura collection (Regression) ya checkboxes se APIs select karo → <strong>API Runner</strong> = sab run + har ka response. <strong>Run test</strong> = load test.</span>
      </div>
      <div class="load-test-user-data" id="loadTestUserDataWrap">
        <div class="user-data-drop-paste" id="userDataDropPaste">
          <textarea id="userDataPaste" class="user-data-paste" placeholder="Yahan paste karo ya file yahan drop karo — CSV ya JSON (har row / object = 1 user). Request mein <<columnName>> use karo." rows="3"></textarea>
          <div class="user-data-actions">
            <span class="user-data-count" id="userDataCount">0 users</span>
            <input type="file" id="userDataFile" accept=".csv,.json,application/json,text/csv,text/plain" style="display:none;" />
            <button type="button" class="btn btn-ghost btn-sm" id="userDataUploadBtn">Upload file</button>
            <button type="button" class="btn btn-ghost btn-sm" id="clearUserDataBtn">Clear</button>
          </div>
        </div>
      </div>

      <div class="runner-output-wrap" id="runnerOutputWrap" style="display:none;">
        <div class="runner-output-head">
          <span class="runner-output-title">API Runner output</span>
          <span class="runner-output-meta" id="runnerOutputMeta"></span>
          <button type="button" class="btn btn-ghost btn-sm" id="runnerOutputClose">✕</button>
        </div>
        <div class="runner-output-list" id="runnerOutputList"></div>
      </div>
      <div class="report" id="report">
        <div class="empty-state" id="emptyState">
          <p>Select an API from the right panel, set Environment (baseUrl & token) and <strong>Send</strong> or <strong>Run test</strong> for load testing.</p>
        </div>
        <div class="live-results-wrap" id="liveResultsWrap" style="display:none;">
          <h3 class="live-results-title">Live results <span class="live-results-count" id="liveResultsCount">0</span></h3>
          <div class="live-results-table-wrap">
            <table class="live-results-table" id="liveResultsTable">
              <thead><tr><th>#</th><th>Name / Path</th><th>Status</th><th>Code</th><th>Duration</th><th>Response / Error</th></tr></thead>
              <tbody id="liveResultsBody"></tbody>
            </table>
          </div>
        </div>
        <div id="reportContent" style="display:none;"></div>
      </div>
    </main>

    <div class="sidebar-wrap" id="sidebarWrap">
      <aside class="sidebar">
        <div class="head">
          <span>Collections</span>
          <div class="head-btns">
            <button type="button" class="btn-expand-sidebar" id="expandSidebarBtn" title="Expand panel to see full names">◐ Expand</button>
            <button type="button" class="btn-add" id="newCollectionBtn" title="New collection">+ Collection</button>
            <button type="button" class="btn-add" id="newRequestBtn" title="New request">+ Request</button>
            <button type="button" id="importBtn" title="Import (Hoppscotch or Postman JSON)">Import</button>
            <button type="button" id="exportBtnCol" title="Export collection">Export</button>
          </div>
        </div>
        <input type="file" id="importFile" accept=".json,application/json" />
        <div class="tree" id="tree"></div>
      </aside>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay" aria-hidden="true"></div>
    <div id="contextMenu" class="context-menu" style="display:none;"></div>
  </div>

  <script>
    const treeEl = document.getElementById('tree');
    const baseUrlEl = document.getElementById('baseUrlEnv');
    const bearerTokenEl = document.getElementById('bearerTokenEnv');
    const iterationsEl = document.getElementById('iterations');
    const concurrencyEl = document.getElementById('concurrency');
    const runBtn = document.getElementById('runBtn');
    const exportBtn = document.getElementById('exportBtn');
    const statusMsg = document.getElementById('statusMsg');
    const emptyState = document.getElementById('emptyState');
    const reportContent = document.getElementById('reportContent');
    const editorMethod = document.getElementById('editorMethod');
    const editorUrl = document.getElementById('editorUrl');
    const paramsBody = document.getElementById('paramsBody');
    const editorTabContent = document.getElementById('editorTabContent');
    const modeTabs = document.querySelectorAll('.load-test-bar .mode-tabs button');
    let currentRequestId = null;
    let lastAuthFormData = null;
    let openTabs = [];
    let loadTestUserData = [];
    const AUTH_TOKEN_KEY = 'postmeter_token';
    const WORKSPACE_KEY = 'postmeter_workspace';
    let currentUser = null;
    let currentWorkspaceId = null;
    let workspacesList = [];
    let skipWorkspaceChangeHandler = false;

    function parseCSV(text) {
      const lines = (text || '').trim().split(/\r?\n/).filter(Boolean);
      if (!lines.length) return [];
      const headers = lines[0].split(',').map((h) => h.replace(/^"|"$/g, '').trim());
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        const values = [];
        let cur = '';
        let inQuotes = false;
        for (let j = 0; j < line.length; j++) {
          const c = line[j];
          if (c === '"') inQuotes = !inQuotes;
          else if ((c === ',' && !inQuotes) || (c === '\t' && !inQuotes)) {
            values.push(cur.trim());
            cur = '';
          } else cur += c;
        }
        values.push(cur.replace(/^"|"$/g, '').trim());
        const obj = {};
        headers.forEach((h, idx) => { obj[h || 'col' + idx] = values[idx] ?? ''; });
        rows.push(obj);
      }
      return rows;
    }
    function parseUserDataInput(text) {
      const t = (text || '').trim();
      if (!t) return [];
      if (t.startsWith('[')) {
        try {
          const arr = JSON.parse(t);
          return Array.isArray(arr) ? arr.map((x) => (x && typeof x === 'object' ? x : {})) : [];
        } catch (_) { return []; }
      }
      return parseCSV(t);
    }
    function updateUserDataCount() {
      const el = document.getElementById('userDataCount');
      if (el) el.textContent = loadTestUserData.length + ' user(s)';
    }

    function formatResponseBody(data) {
      if (data == null) return '(empty)';
      if (typeof data === 'object') return JSON.stringify(data, null, 2);
      const s = String(data).trim();
      if (s === '') return '(empty)';
      if ((s.startsWith('{') && s.includes('}')) || (s.startsWith('[') && s.includes(']'))) {
        try { return JSON.stringify(JSON.parse(s), null, 2); } catch (_) {}
      }
      return s;
    }

    document.getElementById('envDropdownBtn').addEventListener('click', () => {
      const panel = document.getElementById('envPanelDrop');
      panel.classList.toggle('open');
      if (panel.classList.contains('open')) renderCollectionVars();
    });
    (function initSidebarToggle() {
      const btn = document.getElementById('headerCollectionsBtn');
      const wrap = document.getElementById('sidebarWrap');
      const overlay = document.getElementById('sidebarOverlay');
      if (!btn || !wrap || !overlay) return;
      btn.addEventListener('click', () => {
        wrap.classList.toggle('open');
        overlay.classList.toggle('open');
        overlay.setAttribute('aria-hidden', wrap.classList.contains('open') ? 'false' : 'true');
      });
      overlay.addEventListener('click', () => {
        wrap.classList.remove('open');
        overlay.classList.remove('open');
        overlay.setAttribute('aria-hidden', 'true');
      });
    })();
    document.getElementById('leftEnvBtn').addEventListener('click', () => {
      document.getElementById('envPanelDrop').classList.toggle('open');
    });
    document.querySelectorAll('.editor-tabs .etab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.editor-tabs .etab').forEach(t => { t.classList.remove('active'); t.setAttribute('aria-checked', 'false'); });
        tab.classList.add('active');
        tab.setAttribute('aria-checked', 'true');
        const name = tab.dataset.etab;
        if (name === 'params') {
          editorTabContent.innerHTML = '<div class="params-table-wrap"><table class="params-table"><thead><tr><th>Key</th><th>Value</th><th>Description</th><th style="width:44px;"></th></tr></thead><tbody id="paramsBody"></tbody></table><button type="button" class="btn-add-row" id="addParamRowBtn">+ Add parameter</button></div>';
          const b = document.getElementById('paramsBody');
          if (b) renderParamsTable(b, currentRequestId);
        } else if (name === 'body') {
          editorTabContent.innerHTML = '<div class="params-table-wrap"><div class="field" style="margin-bottom:12px;"><label style="display:block;font-size:0.75rem;color:var(--text-muted);margin-bottom:4px;">Content-Type</label><select id="bodyContentType" style="height:36px;padding:0 8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.8125rem;"><option value="application/json">application/json</option><option value="text/plain">text/plain</option><option value="application/x-www-form-urlencoded">application/x-www-form-urlencoded</option></select></div><textarea id="editorBody" style="width:100%;min-height:120px;padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text);font-family:JetBrains Mono,monospace;font-size:0.85rem;" placeholder="Request body (JSON or text)"></textarea></div>';
          const editorBody = document.getElementById('editorBody');
          const bodyContentType = document.getElementById('bodyContentType');
          if (editorBody) editorBody.value = getCurrentRequestBody();
          const item = flat.find(i => i.id === currentRequestId);
          const ct = (item && item.request && item.request.body && item.request.body.contentType) || 'application/json';
          if (bodyContentType) bodyContentType.value = ct;
        } else if (name === 'headers') {
          editorTabContent.innerHTML = '<div class="params-table-wrap"><table class="params-table"><thead><tr><th>Key</th><th>Value</th><th style="width:44px;"></th></tr></thead><tbody id="headersBody"></tbody></table><button type="button" class="btn-add-row">+ Add header</button></div>';
          const b = document.getElementById('headersBody');
          if (b) renderHeadersTable(b, currentRequestId);
        } else if (name === 'auth') {
          const item = flat.find(i => i.id === currentRequestId);
          const auth = (item && item.request && item.request.auth) ? item.request.auth : { authType: 'inherit', token: '', authActive: true, apikeyKey: '', apikeyValue: '', apikeyAddTo: 'header', basicUser: '', basicPass: '' };
          editorTabContent.innerHTML = `<div class="auth-form params-table-wrap">
            <div class="field"><label>Type</label><select id="authType"><option value="inherit" ${auth.authType === 'inherit' ? 'selected' : ''}>Inherit (Environment / Collection token)</option><option value="bearer" ${auth.authType === 'bearer' ? 'selected' : ''}>Bearer Token</option><option value="apikey" ${auth.authType === 'apikey' ? 'selected' : ''}>API Key</option><option value="basic" ${auth.authType === 'basic' ? 'selected' : ''}>Basic Auth</option></select></div>
            <div class="field" id="authBearerField" style="display:${auth.authType === 'bearer' ? 'block' : 'none'}"><label>Token</label><input type="text" id="authToken" value="${escapeHtml(auth.token || '')}" placeholder="Bearer token" /></div>
            <div class="field" id="authApiKeyField" style="display:${auth.authType === 'apikey' ? 'block' : 'none'}"><label>Key</label><input type="text" id="authApiKeyKey" value="${escapeHtml(auth.apikeyKey || '')}" placeholder="e.g. X-API-Key" /><label style="margin-top:8px;">Value</label><input type="text" id="authApiKeyValue" value="${escapeHtml(auth.apikeyValue || '')}" placeholder="API key value" /><label style="margin-top:8px;">Add to</label><select id="authApiKeyAddTo"><option value="header" ${(auth.apikeyAddTo || 'header') === 'header' ? 'selected' : ''}>Header</option><option value="query" ${auth.apikeyAddTo === 'query' ? 'selected' : ''}>Query Params</option></select></div>
            <div class="field" id="authBasicField" style="display:${auth.authType === 'basic' ? 'block' : 'none'}"><label>Username</label><input type="text" id="authBasicUser" value="${escapeHtml(auth.basicUser || '')}" placeholder="Username" /><label style="margin-top:8px;">Password</label><input type="password" id="authBasicPass" value="${escapeHtml(auth.basicPass || '')}" placeholder="Password" /></div>
          </div>`;
          const authTypeEl = document.getElementById('authType');
          const updateAuthFromForm = () => {
            const t = authTypeEl.value;
            lastAuthFormData = {
              authType: t,
              token: (document.getElementById('authToken') || {}).value || '',
              authActive: true,
              apikeyKey: (document.getElementById('authApiKeyKey') || {}).value || '',
              apikeyValue: (document.getElementById('authApiKeyValue') || {}).value || '',
              apikeyAddTo: (document.getElementById('authApiKeyAddTo') || {}).value || 'header',
              basicUser: (document.getElementById('authBasicUser') || {}).value || '',
              basicPass: (document.getElementById('authBasicPass') || {}).value || ''
            };
          };
          authTypeEl.addEventListener('change', function() {
            document.getElementById('authBearerField').style.display = this.value === 'bearer' ? 'block' : 'none';
            document.getElementById('authApiKeyField').style.display = this.value === 'apikey' ? 'block' : 'none';
            document.getElementById('authBasicField').style.display = this.value === 'basic' ? 'block' : 'none';
            updateAuthFromForm();
          });
          ['authToken','authApiKeyKey','authApiKeyValue','authBasicUser','authBasicPass'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', updateAuthFromForm);
          });
          const authApiKeyAddToEl = document.getElementById('authApiKeyAddTo');
          if (authApiKeyAddToEl) authApiKeyAddToEl.addEventListener('change', updateAuthFromForm);
          updateAuthFromForm();
        }
      });
    });
    document.getElementById('sendBtn').addEventListener('click', async () => {
      const id = currentRequestId || (selectedIds.size ? [...selectedIds][0] : null);
      if (!id) { setStatus('Select an API from the right', 'error'); return; }
      const collVars = getCollectionVariables();
      const baseUrl = (currentRequestCollectionName && collVars[currentRequestCollectionName]?.baseUrl) ? collVars[currentRequestCollectionName].baseUrl.trim() : baseUrlEl.value.trim();
      if (!baseUrl && (editorUrl.value || '').includes('<<baseUrl>>')) {
        setStatus('Set baseUrl in Environment or Collection', 'error');
        return;
      }
      const panel = document.getElementById('responsePanel');
      const resStatus = document.getElementById('resStatus');
      const resTime = document.getElementById('resTime');
      const resBody = document.getElementById('resBody');
      panel.style.display = 'block';
      resStatus.textContent = 'Sending…';
      resStatus.className = 'res-status';
      resTime.textContent = '';
      resBody.textContent = '...';
      try {
        const token = (currentRequestCollectionName && collVars[currentRequestCollectionName]?.token) ? collVars[currentRequestCollectionName].token : bearerTokenEl.value.trim();
        const { res, data: result } = await fetchJson('/api/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(withWorkspaceBody({
            requestId: id,
            baseUrl,
            bearerToken: token || undefined,
            collectionVariables: collVars,
          })),
        });
        if (!res.ok) throw new Error(result.error || 'Send failed');
        resStatus.textContent = result.statusCode + (result.statusCode ? ' ' + (result.success ? 'OK' : 'Error') : '');
        resStatus.className = 'res-status ' + (result.success ? 'ok' : 'err');
        resTime.textContent = result.duration ? result.duration + ' ms' : '';
        resBody.textContent = result.error || formatResponseBody(result.data);
        setStatus('Request sent');
      } catch (e) {
        resStatus.textContent = 'Error';
        resStatus.className = 'res-status err';
        resTime.textContent = '';
        resBody.textContent = e.message || 'Request failed';
        setStatus('Error: ' + e.message, 'error');
      }
    });
    document.getElementById('searchCommands').addEventListener('input', (e) => {
      const q = (e.target.value || '').toLowerCase().trim();
      treeEl.querySelectorAll('.tree-item.request').forEach(el => {
        if (!q) { el.style.display = ''; return; }
        el.style.display = (el.textContent || '').toLowerCase().includes(q) ? '' : 'none';
      });
    });
    const STORAGE_TOKEN = 'apiTester_bearerToken';
    const STORAGE_BASE = 'apiTester_baseUrl';
    const STORAGE_EXPANDED = 'apiTester_expandedPaths';
    const STORAGE_COLL_PREFIX = 'apiTester_coll_';
    const STORAGE_SIDEBAR_WIDTH = 'apiTester_sidebarWidth';
    const STORAGE_SIDEBAR_EXPANDED = 'apiTester_sidebarExpanded';

    let flat = [];
    let collections = [];
    let mode = 'single';
    let selectedIds = new Set();
    let lastReport = null;
    let chartInstances = [];
    let expandedPaths = new Set(JSON.parse(localStorage.getItem(STORAGE_EXPANDED) || '[]'));
    let currentRequestCollectionName = '';
    let currentCollectionIndex = 0;
    let currentFolderIndex = null;

    function getCollectionVariables() {
      const out = {};
      collections.forEach(c => {
        const name = c.name || '';
        if (!name) return;
        try {
          const raw = localStorage.getItem(STORAGE_COLL_PREFIX + name);
          const parsed = raw ? JSON.parse(raw) : {};
          out[name] = { baseUrl: parsed.baseUrl || '', token: parsed.token || '' };
        } catch (_) { out[name] = { baseUrl: '', token: '' }; }
      });
      const list = document.getElementById('collectionVarsList');
      if (list) list.querySelectorAll('.coll-block').forEach(block => {
        const n = block.getAttribute('data-collection-name');
        if (!n) return;
        const baseIn = block.querySelector('.coll-baseUrl');
        const tokenIn = block.querySelector('.coll-token');
        if (baseIn && tokenIn) out[n] = { baseUrl: baseIn.value || '', token: tokenIn.value || '' };
      });
      return out;
    }

    function renderCollectionVars() {
      const list = document.getElementById('collectionVarsList');
      if (!list) return;
      list.innerHTML = '';
      const names = [...new Set((collections || []).map(c => c.name).filter(Boolean))];
      names.forEach(name => {
        let baseUrl = '';
        let token = '';
        try {
          const raw = localStorage.getItem(STORAGE_COLL_PREFIX + name);
          if (raw) { const p = JSON.parse(raw); baseUrl = p.baseUrl || ''; token = p.token || ''; }
        } catch (_) {}
        const block = document.createElement('div');
        block.className = 'coll-block';
        block.setAttribute('data-collection-name', name);
        block.innerHTML = `
          <div class="coll-name">${escapeHtml(name)}</div>
          <div class="field-row">
            <label>baseUrl</label>
            <input type="text" class="coll-baseUrl" placeholder="Override for this collection" value="${escapeHtml(baseUrl)}" />
          </div>
          <div class="field-row">
            <label>Token (Inherit)</label>
            <input type="password" class="coll-token" placeholder="Override token" value="${escapeHtml(token)}" autocomplete="off" />
          </div>
        `;
        function saveCollVars() {
          try {
            const b = block.querySelector('.coll-baseUrl').value;
            const t = block.querySelector('.coll-token').value;
            localStorage.setItem(STORAGE_COLL_PREFIX + name, JSON.stringify({ baseUrl: b, token: t }));
          } catch (_) {}
        }
        block.querySelector('.coll-baseUrl').addEventListener('blur', saveCollVars);
        block.querySelector('.coll-baseUrl').addEventListener('input', saveCollVars);
        block.querySelector('.coll-token').addEventListener('blur', saveCollVars);
        block.querySelector('.coll-token').addEventListener('input', saveCollVars);
        list.appendChild(block);
      });
    }

    modeTabs.forEach(btn => {
      btn.addEventListener('click', () => {
        modeTabs.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        mode = btn.dataset.mode;
        renderTree();
      });
    });

    function setStatus(msg, type = '') {
      statusMsg.textContent = msg;
      statusMsg.className = 'status-msg ' + type;
    }
    function getAuthHeader() {
      try {
        const t = localStorage.getItem(AUTH_TOKEN_KEY);
        if (t) return { Authorization: 'Bearer ' + t };
      } catch (_) {}
      return {};
    }
    function getWorkspaceId() {
      return currentWorkspaceId != null ? currentWorkspaceId : null;
    }
    function withWorkspaceBody(body) {
      const wid = getWorkspaceId();
      if (wid == null || body == null) return body;
      return { ...body, workspaceId: wid };
    }
    function withWorkspaceUrl(url) {
      const wid = getWorkspaceId();
      if (wid == null) return url;
      return url + (url.indexOf('?') >= 0 ? '&' : '?') + 'workspaceId=' + encodeURIComponent(wid);
    }
    async function fetchJson(url, opts) {
      const headers = { ...getAuthHeader(), ...(opts && opts.headers) };
      const res = await fetch(url, { ...opts, headers });
      const text = await res.text();
      const trim = (text || '').trim();
      if (trim.startsWith('<')) {
        showServerRequiredBanner();
        throw new Error('Backend server not running. Run: npm start — then open http://localhost:3847');
      }
      let data;
      try {
        data = trim ? JSON.parse(text) : {};
      } catch (_) {
        showServerRequiredBanner();
        throw new Error('Invalid response from server. Run: npm start — then open http://localhost:3847');
      }
      return { res, data };
    }
    function showServerRequiredBanner() {
      let el = document.getElementById('serverRequiredBanner');
      if (el) return;
      el = document.createElement('div');
      el.id = 'serverRequiredBanner';
      el.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:9999;background:var(--warn-muted);border-bottom:2px solid var(--warn);color:var(--text);padding:12px 16px;font-size:0.9rem;display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap;';
      el.innerHTML = '<strong>⚠ Collection / Request save nahi chalega:</strong> Backend server band hai. Terminal mein <code style="background:var(--surface2);padding:4px 8px;border-radius:4px;">npm start</code> chalao, phir browser mein <a href="http://localhost:3847" target="_blank" rel="noopener" style="color:var(--accent);">http://localhost:3847</a> kholo. <button type="button" style="margin-left:8px;padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text);cursor:pointer;">✕</button>';
      el.querySelector('button').onclick = () => { el.remove(); };
      document.body.prepend(el);
    }

    function loadRequestIntoEditor(flatItem) {
      if (!flatItem || !flatItem.request) return;
      const req = flatItem.request;
      currentRequestId = flatItem.id;
      lastAuthFormData = req.auth ? { ...req.auth } : { authType: 'inherit', token: '', authActive: true, apikeyKey: '', apikeyValue: '', apikeyAddTo: 'header', basicUser: '', basicPass: '' };
      currentRequestCollectionName = flatItem.collectionName || '';
      currentCollectionIndex = flatItem.collectionIndex != null ? flatItem.collectionIndex : collections.findIndex(c => (c.name || '') === flatItem.collectionName);
      if (currentCollectionIndex < 0) currentCollectionIndex = 0;
      currentFolderIndex = flatItem.folderIndex != null ? flatItem.folderIndex : null;
      editorMethod.value = (req.method || 'GET').toUpperCase();
      editorUrl.value = req.endpoint || '';
      const tbody = document.getElementById('paramsBody');
      if (tbody) {
        const params = req.params || [];
        const rows = params.length ? params.map(p => paramRowHtml(p.key, p.value, p.description)) : [paramRowHtml('', '', '')];
        tbody.innerHTML = rows.join('');
        const wrap = tbody.closest('.params-table-wrap');
        if (wrap) {
          const addBtn = wrap.querySelector('.btn-add-row');
          if (addBtn && !addBtn._bound) {
            addBtn._bound = true;
            addBtn.addEventListener('click', () => { tbody.insertAdjacentHTML('beforeend', paramRowHtml('', '', '')); });
          }
          tbody.querySelectorAll('.btn-row-del').forEach(btn => {
            btn.addEventListener('click', () => { const tr = btn.closest('tr'); if (tbody.rows.length > 1) tr.remove(); });
          });
        }
      }
    }
    function paramRowHtml(key, value, desc) {
      return `<tr><td><input type="text" value="${escapeHtml(key || '')}" placeholder="Key" /></td><td><input type="text" value="${escapeHtml(value || '')}" placeholder="Value" /></td><td><input type="text" value="${escapeHtml(desc || '')}" placeholder="Description" /></td><td><button type="button" class="btn-row-del" title="Remove">⌫</button></td></tr>`;
    }
    function headerRowHtml(key, value) {
      return `<tr><td><input type="text" value="${escapeHtml(key || '')}" placeholder="Key" /></td><td><input type="text" value="${escapeHtml(value || '')}" placeholder="Value" /></td><td><button type="button" class="btn-row-del" title="Remove">⌫</button></td></tr>`;
    }
    function renderParamsTable(tbodyEl, reqId) {
      if (!tbodyEl) return;
      const item = reqId ? flat.find(i => i.id === reqId) : null;
      const req = item && item.request ? item.request : null;
      const params = (req && req.params) ? req.params : [];
      const rows = params.length ? params.map(p => paramRowHtml(p.key, p.value, p.description)) : [paramRowHtml('', '', '')];
      tbodyEl.innerHTML = rows.join('');
      tbodyEl.closest('.params-table-wrap')?.querySelector('.btn-add-row')?.addEventListener('click', () => {
        tbodyEl.insertAdjacentHTML('beforeend', paramRowHtml('', '', ''));
      });
      tbodyEl.querySelectorAll('.btn-row-del').forEach(btn => {
        btn.addEventListener('click', () => {
          const tr = btn.closest('tr');
          if (tbodyEl.rows.length > 1) tr.remove();
        });
      });
    }
    function renderHeadersTable(tbodyEl, reqId) {
      if (!tbodyEl) return;
      const item = reqId ? flat.find(i => i.id === reqId) : null;
      const req = item && item.request ? item.request : null;
      const headers = (req && req.headers) ? req.headers.filter(h => h.key != null) : [];
      const rows = headers.length ? headers.map(h => headerRowHtml(h.key, h.value)) : [headerRowHtml('', '')];
      tbodyEl.innerHTML = rows.join('');
      tbodyEl.closest('.params-table-wrap')?.querySelector('.btn-add-row')?.addEventListener('click', () => {
        tbodyEl.insertAdjacentHTML('beforeend', headerRowHtml('', ''));
      });
      tbodyEl.querySelectorAll('.btn-row-del').forEach(btn => {
        btn.addEventListener('click', () => {
          const tr = btn.closest('tr');
          if (tbodyEl.rows.length > 1) tr.remove();
        });
      });
    }
    function getCurrentRequestBody() {
      const item = flat.find(i => i.id === currentRequestId);
      return (item && item.request && item.request.body) ? (item.request.body.body ?? '') : '';
    }

    function getRequestFromEditor() {
      const item = flat.find(i => i.id === currentRequestId);
      const existing = (item && item.request) ? item.request : null;
      const method = (editorMethod.value || 'GET').toUpperCase();
      const endpoint = (editorUrl.value || '').trim() || '<<baseUrl>>/';
      let params = existing && (existing.params || []).map(p => ({ key: p.key || '', value: p.value || '', active: p.active !== false, description: p.description || '' }));
      let headers = existing && (existing.headers || []).map(h => ({ key: h.key || '', value: h.value || '', active: h.active !== false }));
      let body = existing && existing.body ? { body: existing.body.body, contentType: existing.body.contentType } : { body: null, contentType: null };
      const pBody = document.getElementById('paramsBody');
      if (pBody && pBody.rows) {
        params = [];
        for (let i = 0; i < pBody.rows.length; i++) {
          const cells = pBody.rows[i].cells;
          if (!cells || cells.length < 2) continue;
          const inputs = pBody.rows[i].querySelectorAll('input');
          if (inputs.length >= 2) params.push({ key: (inputs[0] && inputs[0].value) || '', value: (inputs[1] && inputs[1].value) || '', active: true, description: (inputs[2] && inputs[2].value) || '' });
        }
      }
      const hBody = document.getElementById('headersBody');
      if (hBody && hBody.rows) {
        headers = [];
        for (let i = 0; i < hBody.rows.length; i++) {
          const inputs = hBody.rows[i].querySelectorAll('input');
          if (inputs.length >= 2) headers.push({ key: (inputs[0] && inputs[0].value) || '', value: (inputs[1] && inputs[1].value) || '', active: true });
        }
      }
      const editorBody = document.getElementById('editorBody');
      const bodyContentTypeEl = document.getElementById('bodyContentType');
      const contentType = (bodyContentTypeEl && bodyContentTypeEl.value) || (existing && existing.body && existing.body.contentType) || 'application/json';
      if (editorBody) body = { body: editorBody.value || '', contentType };
      const auth = (lastAuthFormData != null) ? lastAuthFormData : ((existing && existing.auth) || { token: '', authType: 'inherit', authActive: true });
      return { method, endpoint, params, headers, body, auth, name: (existing && existing.name) || 'Untitled request' };
    }

    function renderRequestTabs() {
      const list = document.getElementById('requestTabsList');
      if (!list) return;
      list.innerHTML = openTabs.map(id => {
        const item = flat.find(i => i.id === id);
        const name = (item && item.request && item.request.name) ? item.request.name : id;
        const active = id === currentRequestId ? ' active' : '';
        return `<button type="button" class="request-tab${active}" data-request-id="${escapeHtml(id)}" title="${escapeHtml(name)}"><span class="tab-label">${escapeHtml(name)}</span><span class="tab-close" aria-label="Close">×</span></button>`;
      }).join('');
      list.querySelectorAll('.request-tab').forEach(btn => {
        const id = btn.getAttribute('data-request-id');
        const isClose = (e) => e.target.classList.contains('tab-close');
        btn.addEventListener('click', (e) => {
          if (isClose(e)) {
            e.stopPropagation();
            openTabs = openTabs.filter(x => x !== id);
            if (currentRequestId === id) {
              currentRequestId = openTabs.length ? openTabs[openTabs.length - 1] : null;
              if (currentRequestId) {
                const item = flat.find(i => i.id === currentRequestId);
                if (item) loadRequestIntoEditor(item);
              } else {
                editorMethod.value = 'GET';
                editorUrl.value = '<<baseUrl>>/';
                const tbody = document.getElementById('paramsBody');
                if (tbody) { tbody.innerHTML = paramRowHtml('', '', ''); }
              }
            }
            renderRequestTabs();
            renderTree();
            return;
          }
          currentRequestId = id;
          const item = flat.find(i => i.id === id);
          if (item) loadRequestIntoEditor(item);
          renderRequestTabs();
          renderTree();
        });
      });
    }

    function addRequestToTabs(id) {
      if (!id) return;
      if (!openTabs.includes(id)) openTabs.push(id);
      currentRequestId = id;
      renderRequestTabs();
    }

    function pathKey(path) {
      return (path || '').replace(/"/g, '&quot;');
    }
    function renderFolder(folder, parentPath, depth) {
      const name = folder.name || 'Folder';
      const path = parentPath ? parentPath + ' > ' + name : name;
      const isExpanded = expandedPaths.has(path);
      const safe = pathKey(path);
      const folderReqs = folder.requests || [];
      const fromFlat = flat.filter(i => i.path === path);
      const reqList = folderReqs.length ? folderReqs.map(req => ({ id: req.id, request: req })) : fromFlat;
      let html = `<div class="tree-group${isExpanded ? '' : ' collapsed'}" data-path="${safe}">
        <div class="tree-folder" data-path="${safe}" style="padding-left: ${8 + depth * 14}px">
          <span class="chevron">▾</span>
          <span class="folder-name">${escapeHtml(name)}</span>
          <span class="tree-actions"><button type="button" class="btn-run-folder" data-path="${safe}" title="API Runner on this folder">▶ Run</button></span>
        </div>
        <div class="tree-children">`;
      reqList.forEach(item => {
        const req = item.request || item;
        const id = item.id || req.id;
        const method = (req.method || 'GET').toUpperCase();
        const checked = selectedIds.has(id) ? 'checked' : '';
        const sel = mode === 'single' && selectedIds.has(id) ? ' selected' : '';
        const input = mode === 'multiple' ? `<input type="checkbox" data-id="${id}" ${checked} />` : '';
        html += `<div class="tree-item request${sel}" data-id="${id}" style="padding-left: ${24 + depth * 14}px"><span style="display:flex;align-items:center;flex:1;min-width:0;">${input}<span class="method ${method}">${method}</span><span class="req-name">${escapeHtml(req.name || id)}</span><span class="tree-actions"><button type="button" class="btn-duplicate-req" data-id="${id}" title="Duplicate">⎘</button><button type="button" class="btn-delete-req danger" data-id="${id}" title="Delete">⌫</button></span></span></div>`;
      });
      (folder.folders || []).forEach(sub => {
        html += renderFolder(sub, path, depth + 1);
      });
      html += '</div></div>';
      return html;
    }
    function renderTree() {
      let html = '';
      if (collections.length) {
        collections.forEach((col, colIndex) => {
          const colPath = col.name || 'Collection';
          const isExpanded = expandedPaths.has(colPath);
          const safe = pathKey(colPath);
          const colReqs = col.requests || [];
          const fromFlatCol = flat.filter(i => i.path === colPath);
          const colReqList = colReqs.length ? colReqs.map(req => ({ id: req.id, request: req })) : fromFlatCol;
          html += `<div class="tree-group${isExpanded ? '' : ' collapsed'}" data-path="${safe}">
            <div class="tree-folder" data-path="${safe}" data-col-index="${colIndex}">
              <span class="chevron" aria-label="Expand">▾</span>
              <span class="folder-name">${escapeHtml(colPath)}</span>
              <span class="tree-actions"><button type="button" class="btn-run-folder" data-path="${safe}" title="API Runner on this collection">▶ Run</button><button type="button" class="btn-add-req-to-col" data-col-index="${colIndex}" data-col-path="${safe}" title="Add request to this collection">+ Request</button><button type="button" class="btn-delete-col" data-col-index="${colIndex}" title="Delete collection">⌫</button></span>
            </div>
            <div class="tree-children">`;
          colReqList.forEach(item => {
            const req = item.request || item;
            const id = item.id || req.id;
            const method = (req.method || 'GET').toUpperCase();
            const checked = selectedIds.has(id) ? 'checked' : '';
            const sel = mode === 'single' && selectedIds.has(id) ? ' selected' : '';
            const input = mode === 'multiple' ? `<input type="checkbox" data-id="${id}" ${checked} />` : '';
            html += `<div class="tree-item request${sel}" data-id="${id}"><span style="display:flex;align-items:center;flex:1;min-width:0;">${input}<span class="method ${method}">${method}</span><span class="req-name">${escapeHtml(req.name || id)}</span><span class="tree-actions"><button type="button" class="btn-duplicate-req" data-id="${id}" title="Duplicate">⎘</button><button type="button" class="btn-delete-req danger" data-id="${id}" title="Delete request">⌫</button></span></span></div>`;
          });
          (col.folders || []).forEach(folder => {
            html += renderFolder(folder, colPath, 0);
          });
          html += '</div></div>';
        });
      } else {
        const byPath = {};
        flat.forEach(item => {
          const path = item.path;
          if (!byPath[path]) byPath[path] = [];
          byPath[path].push(item);
        });
        const paths = [...new Set(flat.map(i => i.path))];
        paths.forEach(path => {
          const reqs = byPath[path];
          const first = reqs[0];
          const parts = path.split(' > ');
          const label = parts.length === 1 ? (first?.collectionName || path) : parts[parts.length - 1];
          const isExpanded = expandedPaths.has(path);
          const pathSafe = pathKey(path);
          html += `<div class="tree-group${isExpanded ? '' : ' collapsed'}" data-path="${pathSafe}">
            <div class="tree-folder" data-path="${pathSafe}">
              <span class="chevron">▾</span>
              <span class="folder-name">${escapeHtml(label)}</span>
              <span class="tree-actions"><button type="button" class="btn-run-folder" data-path="${pathSafe}" title="API Runner here">▶ Run</button></span>
            </div>
            <div class="tree-children">`;
          reqs.forEach(r => {
            const req = r.request;
            const method = (req.method || 'GET').toUpperCase();
            const checked = selectedIds.has(r.id) ? 'checked' : '';
            const sel = mode === 'single' && selectedIds.has(r.id) ? ' selected' : '';
            const input = mode === 'multiple' ? `<input type="checkbox" data-id="${r.id}" ${checked} />` : '';
            html += `<div class="tree-item request${sel}" data-id="${r.id}">${input}<span class="method ${method}">${method}</span> ${escapeHtml(req.name || r.id)}</div>`;
          });
          html += '</div></div>';
        });
      }
      treeEl.innerHTML = html || '<div class="tree-item" style="color:var(--textMuted);padding:12px;">No collections – click <strong>+ Collection</strong>, <strong>+ Request</strong>, or <strong>Import</strong></div>';

      treeEl.querySelectorAll('.tree-folder').forEach(el => {
        el.addEventListener('click', (e) => {
          if (e.target.closest('.tree-actions')) return;
          const path = el.getAttribute('data-path');
          const colIdx = el.getAttribute('data-col-index');
          if (colIdx != null && collections[parseInt(colIdx, 10)]) {
            currentCollectionIndex = parseInt(colIdx, 10);
            currentRequestCollectionName = collections[currentCollectionIndex].name || '';
          }
          if (!path) return;
          const group = el.closest('.tree-group');
          if (group.classList.toggle('collapsed')) expandedPaths.delete(path);
          else expandedPaths.add(path);
          try { localStorage.setItem(STORAGE_EXPANDED, JSON.stringify([...expandedPaths])); } catch (_) {}
        });
      });

      treeEl.querySelectorAll('.btn-run-folder').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          e.preventDefault();
          const path = btn.getAttribute('data-path');
          const ids = getRequestIdsForPath(path);
          runApiRunnerWithIds(ids);
        });
      });

      treeEl.querySelectorAll('.btn-add-req-to-col').forEach(btn => {
        btn.addEventListener('click', async (e) => { e.stopPropagation(); e.preventDefault();
          const colIdx = btn.getAttribute('data-col-index');
          const colPath = btn.getAttribute('data-col-path');
          if (colIdx == null) return;
          const idx = parseInt(colIdx, 10);
          const col = collections[idx];
          if (!col) return;
          setStatus('Adding request…');
          try {
            const newReq = { name: 'New Request', method: 'GET', endpoint: '<<baseUrl>>/api/', params: [], headers: [], body: { body: null, contentType: null } };
            const { res, data } = await fetchJson('/api/collections/request', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(withWorkspaceBody({ collectionIndex: idx, folderIndex: null, request: newReq })) });
            if (!res.ok) throw new Error(data.error || 'Add failed');
            flat = data.flat || []; collections = data.collections || [];
            const newId = data.id;
            expandedPaths.add(col.name || colPath || '');
            if (newId) {
              const item = flat.find(i => i.id === newId);
              if (item) { selectedIds.add(newId); addRequestToTabs(newId); loadRequestIntoEditor(item); }
            }
            renderTree();
            renderRequestTabs(); renderCollectionVars();
            setStatus('Request added to ' + (col.name || 'collection'), 'success');
          } catch (err) { setStatus(err.message, 'error'); }
        });
      });

      treeEl.querySelectorAll('.tree-item.request').forEach(el => {
        const id = el.dataset.id;
        el.addEventListener('click', (e) => {
          if (e.target.closest('.tree-actions')) return;
          if (e.target.type === 'checkbox') {
            if (e.target.checked) selectedIds.add(id); else selectedIds.delete(id);
            return;
          }
          if (mode === 'single') {
            selectedIds.clear();
            selectedIds.add(id);
            treeEl.querySelectorAll('.tree-item.request').forEach(r => r.classList.remove('selected'));
            el.classList.add('selected');
            addRequestToTabs(id);
            const flatItem = flat.find(i => i.id === id);
            if (flatItem) loadRequestIntoEditor(flatItem);
          } else if (mode === 'multiple') {
            const cb = el.querySelector('input[type="checkbox"]');
            if (cb) { cb.checked = !cb.checked; if (cb.checked) selectedIds.add(id); else selectedIds.delete(id); }
          }
        });
      });

      treeEl.querySelectorAll('.tree-folder[data-col-index] .folder-name').forEach(span => {
        span.classList.add('editable');
        span.addEventListener('dblclick', (e) => {
          e.stopPropagation();
          const folder = span.closest('.tree-folder');
          const colIndex = folder.getAttribute('data-col-index');
          if (colIndex == null) return;
          const col = collections[parseInt(colIndex, 10)];
          if (!col) return;
          const currentName = (col.name || '').trim() || 'Collection';
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'inline-edit';
          input.value = currentName;
          input.setAttribute('data-col-index', colIndex);
          span.textContent = '';
          span.appendChild(input);
          input.focus();
          input.select();
          const save = async () => {
            const newName = (input.value || '').trim() || currentName;
            input.remove();
            span.textContent = newName;
            try {
              const { res, data } = await fetchJson(`/api/collections/${colIndex}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(withWorkspaceBody({ name: newName })) });
              if (!res.ok) throw new Error(data.error || 'Rename failed');
              collections = data.collections || [];
              flat = data.flat || [];
              expandedPaths.add(newName);
              expandedPaths.delete(col.name);
              renderTree();
              renderRequestTabs();
              renderCollectionVars();
              setStatus('Collection renamed', 'success');
            } catch (err) { setStatus(err.message, 'error'); span.textContent = currentName; }
          };
          input.addEventListener('blur', save);
          input.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') { ev.preventDefault(); input.blur(); } });
        });
      });

      treeEl.querySelectorAll('.tree-item.request .req-name').forEach(span => {
        span.classList.add('editable');
        span.addEventListener('dblclick', (e) => {
          e.stopPropagation();
          const row = span.closest('.tree-item.request');
          const id = row.getAttribute('data-id');
          if (!id) return;
          const item = flat.find(i => i.id === id);
          if (!item || !item.request) return;
          const currentName = (item.request.name || '').trim() || 'Untitled request';
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'inline-edit';
          input.value = currentName;
          input.setAttribute('data-request-id', id);
          span.textContent = '';
          span.appendChild(input);
          input.focus();
          input.select();
          const save = async () => {
            const newName = (input.value || '').trim() || currentName;
            input.remove();
            span.textContent = newName;
            try {
              const payload = getRequestFromEditor();
              if (currentRequestId === id) payload.name = newName;
              else payload.name = newName;
              const { res, data } = await fetchJson(`/api/collections/request/${encodeURIComponent(id)}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(withWorkspaceBody({ request: { name: newName } })) });
              if (!res.ok) throw new Error(data.error || 'Rename failed');
              flat = data.flat || [];
              collections = data.collections || [];
              renderTree();
              renderRequestTabs();
              setStatus('Request renamed', 'success');
            } catch (err) { setStatus(err.message, 'error'); span.textContent = currentName; }
          };
          input.addEventListener('blur', save);
          input.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') { ev.preventDefault(); input.blur(); } });
        });
      });

      treeEl.querySelectorAll('.btn-delete-col').forEach(btn => {
        btn.addEventListener('click', async (e) => { e.stopPropagation(); e.preventDefault();
          const idx = btn.getAttribute('data-col-index');
          if (idx == null) return;
          const col = collections[parseInt(idx, 10)];
          if (!col || !confirm(`Delete collection "${col.name || 'Collection'}"? All requests inside will be removed.`)) return;
          try {
            const { res, data } = await fetchJson(withWorkspaceUrl(`/api/collections/${idx}`), { method: 'DELETE' });
            if (!res.ok) throw new Error(data.error || 'Delete failed');
            flat = data.flat || []; collections = data.collections || [];
            openTabs = openTabs.filter(x => flat.some(i => i.id === x));
            currentRequestId = openTabs.length ? openTabs[openTabs.length - 1] : null;
            if (currentRequestId) { const item = flat.find(i => i.id === currentRequestId); if (item) loadRequestIntoEditor(item); }
            renderTree(); renderRequestTabs(); renderCollectionVars();
            setStatus('Collection deleted', 'success');
          } catch (err) { setStatus(err.message, 'error'); }
        });
      });
      treeEl.querySelectorAll('.btn-delete-req').forEach(btn => {
        btn.addEventListener('click', async (e) => { e.stopPropagation(); e.preventDefault();
          const id = btn.getAttribute('data-id');
            if (!id || !confirm('Delete this request?')) return;
          try {
            const { res, data } = await fetchJson(withWorkspaceUrl(`/api/collections/request/${encodeURIComponent(id)}`), { method: 'DELETE' });
            if (!res.ok) throw new Error(data.error || 'Delete failed');
            flat = data.flat || []; collections = data.collections || [];
            openTabs = openTabs.filter(x => x !== id);
            if (currentRequestId === id) {
              currentRequestId = openTabs.length ? openTabs[openTabs.length - 1] : null;
              if (currentRequestId) { const item = flat.find(i => i.id === currentRequestId); if (item) loadRequestIntoEditor(item); }
            }
            selectedIds.delete(id);
            renderTree();
            renderRequestTabs();
            setStatus('Request deleted', 'success');
          } catch (err) { setStatus(err.message, 'error'); }
        });
      });
      treeEl.querySelectorAll('.btn-duplicate-req').forEach(btn => {
        btn.addEventListener('click', async (e) => { e.stopPropagation(); e.preventDefault();
          const id = btn.getAttribute('data-id');
          if (!id) return;
          try {
            const { res, data } = await fetchJson('/api/collections/request/duplicate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(withWorkspaceBody({ requestId: id })) });
            if (!res.ok) throw new Error(data.error || 'Duplicate failed');
            flat = data.flat || []; collections = data.collections || [];
            const newId = data.id;
            if (newId) { selectedIds.add(newId); addRequestToTabs(newId); expandedPaths.add(flat.find(i => i.id === newId)?.path || ''); }
            renderTree();
            renderRequestTabs();
            const flatItem = flat.find(i => i.id === newId);
            if (flatItem) loadRequestIntoEditor(flatItem);
            setStatus('Request duplicated', 'success');
          } catch (err) { setStatus(err.message, 'error'); }
        });
      });
    }
    function escapeHtml(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    function collectPaths(cols, parent) {
      const list = [];
      (cols || []).forEach(c => {
        const path = parent ? parent + ' > ' + (c.name || 'Folder') : (c.name || 'Collection');
        list.push(path);
        list.push(...collectPaths(c.folders || [], path));
      });
      return list;
    }
    function syncWorkspaceFromDropdown() {
      const wsSelect = document.getElementById('workspaceSelect');
      if (!wsSelect) return;
      const v = wsSelect.value;
      const nextId = v ? parseInt(v, 10) : null;
      if (v === '' || v === undefined) {
        currentWorkspaceId = null;
        return;
      }
      if (nextId != null && (!currentUser || workspacesList.some((w) => w.id === nextId))) {
        currentWorkspaceId = nextId;
        return;
      }
      if (currentUser && workspacesList.length && currentWorkspaceId != null && !workspacesList.some((w) => w.id === currentWorkspaceId)) {
        currentWorkspaceId = workspacesList[0].id;
        wsSelect.value = String(currentWorkspaceId);
        try { localStorage.setItem(WORKSPACE_KEY, String(currentWorkspaceId)); } catch (_) {}
      }
    }
    async function loadCollections() {
      setStatus('Loading collections…');
      try {
        const wsSelect = document.getElementById('workspaceSelect');
        const selectedValue = wsSelect ? (wsSelect.value ?? '') : '';
        const wid = (selectedValue !== '' && selectedValue != null) ? parseInt(selectedValue, 10) : null;
        const requestedWorkspaceId = (wid != null && !isNaN(wid)) ? wid : null;
        syncWorkspaceFromDropdown();
        if (requestedWorkspaceId != null) currentWorkspaceId = requestedWorkspaceId;
        else if (selectedValue === '' || selectedValue == null) currentWorkspaceId = null;
        if (requestedWorkspaceId != null) {
          flat = [];
          collections = [];
          currentRequestId = null;
          openTabs = [];
          selectedIds.clear();
          if (editorMethod) editorMethod.value = 'GET';
          if (editorUrl) editorUrl.value = '<<baseUrl>>/';
          document.getElementById('resStatus').textContent = '–';
          document.getElementById('resTime').textContent = '';
          var rb = document.getElementById('resBody');
          if (rb) rb.textContent = 'Send a request to see response.';
          renderTree();
          renderRequestTabs();
        }
        const url = requestedWorkspaceId != null ? '/api/collections?workspaceId=' + encodeURIComponent(requestedWorkspaceId) : '/api/collections';
        const { res, data } = await fetchJson(url);
        if (!res.ok) throw new Error(data.error || 'Failed to load');
        var nowSelected = wsSelect ? (wsSelect.value ?? '') : '';
        var nowWid = (nowSelected !== '' && nowSelected != null) ? parseInt(nowSelected, 10) : null;
        if (requestedWorkspaceId !== nowWid) { loadCollections(); return; }
        flat = data.flat || [];
        collections = Array.isArray(data.collections) ? data.collections : [];
        currentCollectionIndex = collections.length ? Math.min(currentCollectionIndex, collections.length - 1) : 0;
        currentRequestCollectionName = collections[currentCollectionIndex] ? (collections[currentCollectionIndex].name || '') : '';
        const currentRequestInThisWorkspace = currentRequestId && flat.some((r) => r.id === currentRequestId);
        if (!currentRequestInThisWorkspace) {
          currentRequestId = null;
          openTabs = openTabs.filter((id) => flat.some((r) => r.id === id));
          selectedIds.clear();
          if (editorMethod) editorMethod.value = 'GET';
          if (editorUrl) editorUrl.value = '<<baseUrl>>/';
          document.getElementById('resStatus').textContent = '–';
          document.getElementById('resTime').textContent = '';
          const resBody = document.getElementById('resBody');
          if (resBody) resBody.textContent = 'Send a request to see response.';
        }
        if (collections.length === 0) selectedIds.clear();
        loadSavedPrefs();
        if (data.env) {
          if (data.env.baseUrl != null && data.env.baseUrl !== '') { baseUrlEl.value = data.env.baseUrl; try { localStorage.setItem(STORAGE_BASE, data.env.baseUrl); } catch (_) {} }
          if (data.env.bearerToken != null && data.env.bearerToken !== '') { bearerTokenEl.value = data.env.bearerToken; try { localStorage.setItem(STORAGE_TOKEN, data.env.bearerToken); } catch (_) {} }
        }
        expandedPaths.clear();
        try { localStorage.setItem(STORAGE_EXPANDED, '[]'); } catch (_) {}
        if (mode === 'single' && flat.length && selectedIds.size === 0) selectedIds.add(flat[0].id);
        renderTree();
        renderCollectionVars();
        renderRequestTabs();
        if (mode === 'single' && flat.length) {
          const firstId = [...selectedIds][0] || flat[0].id;
          const item = flat.find(i => i.id === firstId);
          if (item) loadRequestIntoEditor(item);
        } else if (flat.length === 0) {
          document.getElementById('resStatus').textContent = '–';
          document.getElementById('resTime').textContent = '';
          document.getElementById('resBody').textContent = 'Send a request to see response.';
        }
        setStatus(collections.length ? `Loaded ${flat.length} APIs` : 'No collections – click + Collection or + Request');
        if (typeof updateDeleteWorkspaceButton === 'function') updateDeleteWorkspaceButton();
      } catch (e) {
        if (typeof showServerRequiredBanner === 'function') showServerRequiredBanner();
        setStatus('Error: ' + e.message, 'error');
        flat = [];
        collections = [];
        currentCollectionIndex = 0;
        currentRequestId = null;
        openTabs = [];
        selectedIds.clear();
        loadSavedPrefs();
        renderTree();
        renderRequestTabs();
      }
    }

    function loadSavedPrefs() {
      try {
        const t = localStorage.getItem(STORAGE_TOKEN);
        if (t != null) bearerTokenEl.value = t;
        const b = localStorage.getItem(STORAGE_BASE);
        if (b != null) baseUrlEl.value = b;
      } catch (_) {}
    }
    function saveToken() {
      try { localStorage.setItem(STORAGE_TOKEN, bearerTokenEl.value); } catch (_) {}
    }
    function saveBaseUrl() {
      try { localStorage.setItem(STORAGE_BASE, baseUrlEl.value); } catch (_) {}
    }
    bearerTokenEl.addEventListener('change', saveToken);
    bearerTokenEl.addEventListener('blur', saveToken);
    baseUrlEl.addEventListener('blur', saveBaseUrl);

    document.getElementById('exportBtnCol').addEventListener('click', async () => {
      try {
        const url = withWorkspaceUrl('/api/collections/export');
        const res = await fetch(url, { headers: getAuthHeader() });
        if (!res.ok) throw new Error('Export failed');
        const blob = await res.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'collection.json';
        a.click();
        URL.revokeObjectURL(a.href);
        setStatus('Export started');
      } catch (e) {
        setStatus('Export error: ' + e.message, 'error');
      }
    });

    (function initSidebarResizeAndExpand() {
      const app = document.querySelector('.app');
      const wrap = document.getElementById('sidebarWrap');
      const resizeEl = document.getElementById('centerResize');
      const expandBtn = document.getElementById('expandSidebarBtn');
      const minW = 260, maxW = 720;
      const expandedWidth = Math.min(520, Math.max(400, Math.floor((typeof window !== 'undefined' && window.innerWidth) ? window.innerWidth * 0.45 : 480)));
      let isExpanded = false;
      try { isExpanded = localStorage.getItem(STORAGE_SIDEBAR_EXPANDED) === '1'; } catch (_) {}
      function applyExpanded(expanded) {
        isExpanded = expanded;
        if (wrap) wrap.classList.toggle('expanded', expanded);
        if (app) app.style.setProperty('--sidebar-width', expanded ? (expandedWidth + 'px') : (app.getAttribute('data-sidebar-normal-width') || '320px'));
        if (expandBtn) expandBtn.textContent = expanded ? 'Collapse' : 'Expand';
        try { localStorage.setItem(STORAGE_SIDEBAR_EXPANDED, expanded ? '1' : '0'); } catch (_) {}
      }
      try {
        const saved = localStorage.getItem(STORAGE_SIDEBAR_WIDTH);
        if (saved && !isExpanded) { const parsed = parseInt(saved.replace(/\D/g, ''), 10); if (!isNaN(parsed)) { const w = Math.min(maxW, Math.max(minW, parsed)); app.style.setProperty('--sidebar-width', w + 'px'); app.setAttribute('data-sidebar-normal-width', w + 'px'); } }
        else if (app && !app.getAttribute('data-sidebar-normal-width')) app.setAttribute('data-sidebar-normal-width', '320px');
      } catch (_) {}
      if (expandBtn && wrap && app) {
        expandBtn.addEventListener('click', () => {
          if (!isExpanded) app.setAttribute('data-sidebar-normal-width', app.style.getPropertyValue('--sidebar-width') || '320px');
          applyExpanded(!isExpanded);
        });
        if (isExpanded) applyExpanded(true);
      } else if (app) {
        app.setAttribute('data-sidebar-normal-width', app.style.getPropertyValue('--sidebar-width') || '320px');
      }
      if (!resizeEl || !app) return;
      let startX = 0, startW = 0;
      function onMove(e) {
        const dx = e.clientX - startX;
        let w = Math.min(maxW, Math.max(minW, startW + dx));
        app.style.setProperty('--sidebar-width', w + 'px');
        if (!isExpanded) app.setAttribute('data-sidebar-normal-width', w + 'px');
      }
      function onUp() {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        try { localStorage.setItem(STORAGE_SIDEBAR_WIDTH, app.style.getPropertyValue('--sidebar-width') || '320'); } catch (_) {}
      }
      resizeEl.addEventListener('mousedown', (e) => {
        e.preventDefault();
        if (wrap && isExpanded) { wrap.classList.remove('expanded'); isExpanded = false; if (expandBtn) expandBtn.textContent = 'Expand'; try { localStorage.setItem(STORAGE_SIDEBAR_EXPANDED, '0'); } catch (_) {} }
        startX = e.clientX;
        const w = app.style.getPropertyValue('--sidebar-width');
        startW = w ? parseInt(w, 10) : 320;
        startW = Math.min(maxW, Math.max(minW, startW));
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      });
    })();

    (function initCollectionContextMenu() {
      const menu = document.getElementById('contextMenu');
      if (!menu || !treeEl) return;
      treeEl.addEventListener('contextmenu', (e) => {
        const folder = e.target.closest('.tree-folder[data-col-index]');
        if (!folder) return;
        e.preventDefault();
        const colIdx = folder.getAttribute('data-col-index');
        const colPath = folder.getAttribute('data-col-path') || folder.getAttribute('data-path');
        const col = collections[parseInt(colIdx, 10)];
        if (!col) return;
        menu.innerHTML = '<button type="button" data-action="add">+ Add request</button><button type="button" data-action="delete" class="danger">Delete collection</button>';
        menu.style.left = e.clientX + 'px';
        menu.style.top = e.clientY + 'px';
        menu.style.display = 'block';
        function hide() { menu.style.display = 'none'; document.removeEventListener('click', hide); }
        document.addEventListener('click', hide);
        menu.onclick = (ev) => {
          const btn = ev.target.closest('button[data-action]');
          if (!btn) return;
          ev.stopPropagation();
          menu.style.display = 'none';
          document.removeEventListener('click', hide);
          const idx = parseInt(colIdx, 10);
          if (btn.dataset.action === 'delete') {
            if (!confirm('Delete collection "' + (col.name || 'Collection') + '"?')) return;
            fetchJson(withWorkspaceUrl('/api/collections/' + idx), { method: 'DELETE' }).then(({ res, data }) => {
              if (!res.ok) throw new Error(data.error || 'Delete failed');
              flat = data.flat || []; collections = data.collections || [];
              openTabs = openTabs.filter(x => flat.some(i => i.id === x));
              currentRequestId = openTabs.length ? openTabs[openTabs.length - 1] : null;
              if (currentRequestId) { const item = flat.find(i => i.id === currentRequestId); if (item) loadRequestIntoEditor(item); }
              renderTree(); renderRequestTabs(); renderCollectionVars();
              setStatus('Collection deleted', 'success');
            }).catch(err => setStatus(err.message, 'error'));
          } else if (btn.dataset.action === 'add') {
            setStatus('Adding request…');
            const newReq = { name: 'New Request', method: 'GET', endpoint: '<<baseUrl>>/api/', params: [], headers: [], body: { body: null, contentType: null } };
            fetchJson('/api/collections/request', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(withWorkspaceBody({ collectionIndex: idx, folderIndex: null, request: newReq })) }).then(({ res, data }) => {
              if (!res.ok) throw new Error(data.error || 'Add failed');
              flat = data.flat || []; collections = data.collections || [];
              const newId = data.id;
              expandedPaths.add(col.name || colPath || '');
              if (newId) { const item = flat.find(i => i.id === newId); if (item) { selectedIds.add(newId); addRequestToTabs(newId); loadRequestIntoEditor(item); } }
              renderTree(); renderRequestTabs(); renderCollectionVars();
              setStatus('Request added', 'success');
            }).catch(err => setStatus(err.message, 'error'));
          }
        };
      });
    })();

    document.getElementById('newCollectionBtn').addEventListener('click', async () => {
      syncWorkspaceFromDropdown();
      try {
        const { res, data } = await fetchJson('/api/collections', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(withWorkspaceBody({ name: 'New Collection' })) });
        if (!res.ok) throw new Error(data.error || 'Failed');
        flat = data.flat || [];
        collections = Array.isArray(data.collections) ? data.collections : [];
        currentCollectionIndex = collections.length ? collections.length - 1 : 0;
        const newCol = collections[currentCollectionIndex];
        currentRequestCollectionName = newCol ? (newCol.name || '') : '';
        if (newCol && newCol.name) expandedPaths.add(newCol.name);
        renderTree();
        renderCollectionVars();
        renderRequestTabs();
        setStatus('Collection added – click "+ Request" or add requests in the tree', 'success');
      } catch (err) { setStatus(err.message || 'Failed to add collection', 'error'); }
    });

    document.getElementById('newRequestBtn').addEventListener('click', () => {
      syncWorkspaceFromDropdown();
      currentRequestId = null;
      openTabs = [];
      lastAuthFormData = { authType: 'inherit', token: '', authActive: true, apikeyKey: '', apikeyValue: '', apikeyAddTo: 'header', basicUser: '', basicPass: '' };
      if (currentCollectionIndex < 0 || currentCollectionIndex >= collections.length) currentCollectionIndex = collections.length ? 0 : 0;
      currentFolderIndex = null;
      currentRequestCollectionName = collections[currentCollectionIndex] ? (collections[currentCollectionIndex].name || '') : '';
      editorMethod.value = 'GET';
      editorUrl.value = '<<baseUrl>>/';
      const tbody = document.getElementById('paramsBody');
      if (tbody) {
        tbody.innerHTML = paramRowHtml('', '', '');
        const wrap = tbody.closest('.params-table-wrap');
        if (wrap) {
          const addBtn = wrap.querySelector('.btn-add-row');
          if (addBtn && !addBtn._bound) {
            addBtn._bound = true;
            addBtn.addEventListener('click', () => { tbody.insertAdjacentHTML('beforeend', paramRowHtml('', '', '')); });
          }
        }
      }
      document.getElementById('resStatus').textContent = '–';
      document.getElementById('resTime').textContent = '';
      var resBodyEl = document.getElementById('resBody');
      if (resBodyEl) resBodyEl.textContent = 'Send a request to see response.';
      renderRequestTabs();
      setStatus(collections.length ? 'New request – edit and click Save to add to ' + (currentRequestCollectionName || 'collection') : 'New request – edit and click Save (a collection will be created)');
    });

    document.getElementById('saveRequestBtn').addEventListener('click', async () => {
      syncWorkspaceFromDropdown();
      const payload = getRequestFromEditor();
      if (!payload.name) payload.name = 'Untitled request';
      try {
        if (currentRequestId) {
          const { res, data } = await fetchJson(`/api/collections/request/${encodeURIComponent(currentRequestId)}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(withWorkspaceBody({ request: payload })) });
          if (!res.ok) throw new Error(data.error || 'Save failed');
          flat = data.flat || []; collections = data.collections || [];
          renderTree(); renderCollectionVars();
          setStatus('Request saved', 'success');
        } else {
          const colIdx = Math.max(0, currentCollectionIndex);
          const { res, data } = await fetchJson('/api/collections/request', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(withWorkspaceBody({ collectionIndex: colIdx, folderIndex: currentFolderIndex, request: payload })) });
          if (!res.ok) throw new Error(data.error || 'Add failed');
          flat = data.flat || []; collections = data.collections || [];
          const newId = data.id;
          if (newId) { currentRequestId = newId; addRequestToTabs(newId); const item = flat.find(i => i.id === newId); if (item) loadRequestIntoEditor(item); expandedPaths.add(currentRequestCollectionName || (collections[colIdx] && collections[colIdx].name) || ''); }
          renderTree(); renderRequestTabs(); renderCollectionVars();
          setStatus('Request added', 'success');
        }
      } catch (err) { setStatus(err.message, 'error'); }
    });

    document.getElementById('duplicateRequestBtn').addEventListener('click', async () => {
      if (!currentRequestId) { setStatus('Select a request to duplicate', 'error'); return; }
      try {
        const { res, data } = await fetchJson('/api/collections/request/duplicate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(withWorkspaceBody({ requestId: currentRequestId })) });
        if (!res.ok) throw new Error(data.error || 'Duplicate failed');
        flat = data.flat || []; collections = data.collections || [];
        const newId = data.id;
        if (newId) { selectedIds.add(newId); addRequestToTabs(newId); const item = flat.find(i => i.id === newId); if (item) { expandedPaths.add(item.path); loadRequestIntoEditor(item); } }
        renderTree();
        renderRequestTabs();
        setStatus('Request duplicated', 'success');
      } catch (err) { setStatus(err.message, 'error'); }
    });

    const importFile = document.getElementById('importFile');
    document.getElementById('importBtn').addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      setStatus('Importing…');
      try {
        const text = await new Promise((res, rej) => {
          const r = new FileReader();
          r.onload = () => res(r.result);
          r.onerror = rej;
          r.readAsText(file);
        });
        const json = JSON.parse(text);
        if (typeof json !== 'object') throw new Error('Invalid JSON');
        const uploadUrl = withWorkspaceUrl('/api/collections/upload');
        const { res, data } = await fetchJson(uploadUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(json),
        });
        if (!res.ok) throw new Error(data.error || 'Import failed');
        flat = data.flat || [];
        collections = Array.isArray(data.collections) ? data.collections : [];
        expandedPaths.clear();
        try { localStorage.setItem(STORAGE_EXPANDED, '[]'); } catch (_) {}
        renderTree();
        if (flat.length && selectedIds.size === 0) selectedIds.add(flat[0].id);
        setStatus(`Imported ${flat.length} APIs`, 'success');
      } catch (err) {
        setStatus('Import error: ' + err.message, 'error');
      }
      importFile.value = '';
    });

    function getRequestIds() {
      if (mode === 'regression') return flat.map(r => r.id);
      return [...selectedIds];
    }
    function getRequestIdsForPath(path) {
      if (!path) return [];
      const p = String(path).replace(/&quot;/g, '"');
      if (p.indexOf(' > ') >= 0) return flat.filter((i) => i.path === p).map((i) => i.id);
      return flat.filter((i) => i.path === p || i.path.startsWith(p + ' > ')).map((i) => i.id);
    }
    async function runApiRunnerWithIds(ids) {
      if (!ids || !ids.length) {
        setStatus('No APIs in this collection/folder', 'error');
        return;
      }
      const collVars = getCollectionVariables();
      const baseUrl = (baseUrlEl.value || '').trim();
      const needsBase = ids.some((id) => (flat.find((r) => r.id === id)?.request?.endpoint || '').includes('<<baseUrl>>'));
      if (needsBase && !baseUrl && !Object.values(collVars).some((c) => (c.baseUrl || '').trim())) {
        setStatus('Set baseUrl in Environment or Collection', 'error');
        return;
      }
      const wrap = document.getElementById('runnerOutputWrap');
      const listEl = document.getElementById('runnerOutputList');
      const metaEl = document.getElementById('runnerOutputMeta');
      wrap.style.display = 'flex';
      listEl.innerHTML = '';
      metaEl.textContent = 'Running ' + ids.length + ' request(s)…';
      const runnerBtn = document.getElementById('runnerBtn');
      if (runnerBtn) runnerBtn.disabled = true;
      const results = [];
      for (let i = 0; i < ids.length; i++) {
        const id = ids[i];
        const item = flat.find((r) => r.id === id);
        const name = (item && item.request && item.request.name) ? item.request.name : id;
        const method = (item && item.request && item.request.method) ? (item.request.method || 'GET').toUpperCase() : 'GET';
        metaEl.textContent = 'Running ' + (i + 1) + '/' + ids.length + ': ' + name;
        try {
          const { res, data: result } = await fetchJson('/api/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(withWorkspaceBody({
              requestId: id,
              baseUrl,
              bearerToken: bearerTokenEl.value.trim() || undefined,
              collectionVariables: collVars,
            })),
          });
          const statusCode = result.statusCode != null ? result.statusCode : (res.ok ? 200 : 0);
          const success = result.success !== false && statusCode >= 200 && statusCode < 300;
          const bodyText = result.error || formatResponseBody(result.data);
          results.push({ id, name, method, statusCode, success, duration: result.duration || 0, body: bodyText });
        } catch (e) {
          results.push({ id, name, method, statusCode: 0, success: false, duration: 0, body: e.message || 'Request failed' });
        }
        const last = results[results.length - 1];
        const itemEl = document.createElement('div');
        itemEl.className = 'runner-item';
        itemEl.innerHTML = `
          <div class="runner-item-head">
            <span class="method ${last.method}">${escapeHtml(last.method)}</span>
            <span class="name" title="${escapeHtml(last.name)}">${escapeHtml(last.name)}</span>
            <span class="status ${last.success ? 'ok' : 'err'}">${last.statusCode} ${last.success ? 'OK' : 'Error'}</span>
            <span class="time">${last.duration} ms</span>
            <span class="chevron">▸</span>
          </div>
          <div class="runner-item-body"><pre>${escapeHtml(last.body)}</pre></div>
        `;
        itemEl.querySelector('.runner-item-head').addEventListener('click', () => itemEl.classList.toggle('expanded'));
        listEl.appendChild(itemEl);
      }
      const total = results.length;
      const passed = results.filter((r) => r.success).length;
      metaEl.textContent = total + ' request(s) run — ' + passed + ' passed, ' + (total - passed) + ' failed';
      if (runnerBtn) runnerBtn.disabled = false;
      setStatus('API Runner finished: ' + passed + '/' + total + ' passed', passed === total ? 'success' : 'error');
    }

    const liveResultsWrap = document.getElementById('liveResultsWrap');
      const liveResultsBody = document.getElementById('liveResultsBody');
      const liveResultsCountEl = document.getElementById('liveResultsCount');

      function appendLiveRow(result, index) {
        if (!liveResultsBody) return;
        const name = (result.name || result.path || '–');
        const status = result.success ? 'OK' : 'FAIL';
        const code = result.statusCode != null ? result.statusCode : '–';
        const duration = result.duration != null ? result.duration + ' ms' : '–';
        const preview = (result.bodyPreview != null && result.bodyPreview !== '') ? String(result.bodyPreview).slice(0, 120) : (result.error || '–');
        const tr = document.createElement('tr');
        tr.className = result.success ? 'success' : 'failed';
        tr.innerHTML = '<td>' + index + '</td><td>' + escapeHtml(name) + '</td><td>' + escapeHtml(status) + '</td><td>' + escapeHtml(String(code)) + '</td><td>' + escapeHtml(String(duration)) + '</td><td class="response-preview" title="' + escapeHtml(preview) + '">' + escapeHtml(preview) + '</td>';
        liveResultsBody.appendChild(tr);
        if (liveResultsCountEl) liveResultsCountEl.textContent = liveResultsBody.querySelectorAll('tr').length;
        const wrap = document.querySelector('.live-results-table-wrap');
        if (wrap) wrap.scrollTop = wrap.scrollHeight;
      }

      runBtn.addEventListener('click', async () => {
        const ids = getRequestIds();
        if (mode !== 'regression' && !ids.length) {
          setStatus('Select at least one API', 'error');
          return;
        }
        const collVars = getCollectionVariables();
        const anyBase = baseUrlEl.value.trim() || Object.values(collVars).some(c => (c.baseUrl || '').trim());
        if (!anyBase && flat.length && (flat[0]?.request?.endpoint || '').includes('<<baseUrl>>')) {
          setStatus('Set baseUrl in Environment or per collection', 'error');
          return;
        }
        const baseUrl = baseUrlEl.value.trim();

        runBtn.disabled = true;
        runBtn.classList.add('running');
        const durationSec = parseInt(document.getElementById('durationSeconds')?.value, 10) || 0;
        const iterCount = durationSec > 0 ? 0 : Math.max(1, parseInt(iterationsEl.value, 10) || 1);
        const reqCount = mode === 'regression' ? (flat.length * iterCount) : (ids.length * iterCount);
        const estMin = Math.ceil((reqCount * 0.5) / 60) || 1;
        setStatus('Running test on server (' + reqCount + ' requests, wait up to ~' + estMin + ' min)… Do not close.');
        emptyState.style.display = 'none';
        if (liveResultsWrap) { liveResultsWrap.style.display = 'block'; }
        if (liveResultsCountEl) liveResultsCountEl.textContent = '0';
        if (liveResultsBody) liveResultsBody.innerHTML = '';
        reportContent.style.display = 'block';
        reportContent.innerHTML = '<p class="report-wait-msg" style="padding:24px;color:var(--textMuted);">Report will appear below when test completes.</p>';

        let runTimeout;
        try {
          const delayMs = Math.max(0, parseInt(document.getElementById('delayBetweenMs')?.value, 10) || 0);
          const slaMin = Math.min(100, Math.max(0, parseFloat(document.getElementById('slaMinSuccessRate')?.value) || 0));
          const slaP95 = Math.max(0, parseInt(document.getElementById('slaMaxP95Ms')?.value, 10) || 0);
          const runAbort = new AbortController();
          runTimeout = setTimeout(() => runAbort.abort(), 5 * 60 * 1000);
          const payload = {
            type: mode === 'regression' ? 'regression' : (mode === 'multiple' ? 'multiple' : 'single'),
            requestIds: ids,
            baseUrl,
            bearerToken: bearerTokenEl.value.trim() || undefined,
            collectionVariables: getCollectionVariables(),
            iterations: durationSec > 0 ? 1 : Math.max(1, parseInt(iterationsEl.value, 10) || 1),
            concurrency: Math.max(1, parseInt(concurrencyEl.value, 10) || 1),
            durationSeconds: durationSec > 0 ? durationSec : 0,
            delayBetweenRequestsMs: delayMs,
            rampUpSeconds: Math.max(0, parseInt(document.getElementById('rampUpSeconds')?.value, 10) || 0),
            workers: Math.min(8, Math.max(1, parseInt(document.getElementById('workers')?.value, 10) || 1)),
            sla: (slaMin > 0 || slaP95 > 0) ? { minSuccessRate: slaMin, maxP95Ms: slaP95 } : {},
            userData: loadTestUserData.length ? loadTestUserData : undefined,
            globalVariables: {},
            stream: true,
          };
          const wid = getWorkspaceId();
          if (wid != null) payload.workspaceId = wid;
          const res = await fetch('/api/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...getAuthHeader() },
            signal: runAbort.signal,
            body: JSON.stringify(payload),
          });
          clearTimeout(runTimeout);
          if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            throw new Error(errData.error || 'Run failed');
          }
          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let buf = '';
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buf += decoder.decode(value, { stream: true });
            const lines = buf.split('\n');
            buf = lines.pop() || '';
            for (const line of lines) {
              const trimmed = line.trim();
              if (!trimmed) continue;
              try {
                const obj = JSON.parse(trimmed);
                if (obj.type === 'result' && obj.result) appendLiveRow(obj.result, obj.index != null ? obj.index : (liveResultsBody ? liveResultsBody.querySelectorAll('tr').length + 1 : 1));
                else if (obj.type === 'report' && obj.report) {
                  lastReport = obj.report;
                  renderReport(obj.report);
                  exportBtn.disabled = false;
                  const printReportBtn = document.getElementById('printReportBtn');
                  const exportHtmlBtn = document.getElementById('exportHtmlBtn');
                  if (printReportBtn) printReportBtn.disabled = false;
                  if (exportHtmlBtn) exportHtmlBtn.disabled = false;
                  setStatus('Done: ' + obj.report.totalCalls + ' requests in ' + (obj.report.totalTime / 1000).toFixed(2) + 's', 'success');
                }
              } catch (_) {}
            }
          }
          if (buf.trim()) {
            try {
              const obj = JSON.parse(buf.trim());
              if (obj.type === 'result' && obj.result) appendLiveRow(obj.result, obj.index != null ? obj.index : (liveResultsBody ? liveResultsBody.querySelectorAll('tr').length + 1 : 1));
              else if (obj.type === 'report' && obj.report) {
                lastReport = obj.report;
                renderReport(obj.report);
                exportBtn.disabled = false;
                const printReportBtn = document.getElementById('printReportBtn');
                const exportHtmlBtn = document.getElementById('exportHtmlBtn');
                if (printReportBtn) printReportBtn.disabled = false;
                if (exportHtmlBtn) exportHtmlBtn.disabled = false;
                setStatus('Done: ' + obj.report.totalCalls + ' requests in ' + (obj.report.totalTime / 1000).toFixed(2) + 's', 'success');
              }
            } catch (_) {}
          }
        } catch (e) {
          if (runTimeout) clearTimeout(runTimeout);
          const msg = (e && e.name === 'AbortError') ? 'Test timed out (5 min). Server slow or not responding? Check npm start is running.' : e.message;
          setStatus('Error: ' + msg, 'error');
        } finally {
          runBtn.disabled = false;
          runBtn.classList.remove('running');
        }
      });

    document.getElementById('runnerBtn').addEventListener('click', async () => {
      const ids = getRequestIds();
      if (mode !== 'regression' && !ids.length) {
        setStatus('Select at least one API for API Runner, or use Regression for full collection', 'error');
        return;
      }
      runApiRunnerWithIds(ids);
    });

    document.getElementById('runnerOutputClose').addEventListener('click', () => {
      document.getElementById('runnerOutputWrap').style.display = 'none';
    });

    (function initUserData() {
      const dropZone = document.getElementById('userDataDropPaste');
      const fileEl = document.getElementById('userDataFile');
      const pasteEl = document.getElementById('userDataPaste');
      const clearBtn = document.getElementById('clearUserDataBtn');
      const uploadBtn = document.getElementById('userDataUploadBtn');

      function applyUserData(text) {
        loadTestUserData = parseUserDataInput(text);
        if (pasteEl) pasteEl.value = text;
        updateUserDataCount();
        if (loadTestUserData.length) setStatus(loadTestUserData.length + ' users loaded — ab Run test chalao', 'success');
      }

      if (dropZone) {
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.classList.remove('drag-over');
          const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
          if (!file) return;
          const r = new FileReader();
          r.onload = () => { applyUserData(r.result); setStatus('File loaded: ' + loadTestUserData.length + ' users', 'success'); };
          r.onerror = () => setStatus('File read error', 'error');
          r.readAsText(file);
        });
      }
      if (uploadBtn && fileEl) uploadBtn.addEventListener('click', () => fileEl.click());
      if (fileEl) fileEl.addEventListener('change', async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        try {
          const text = await new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsText(file); });
          applyUserData(text);
        } catch (err) { setStatus('File error: ' + err.message, 'error'); }
        e.target.value = '';
      });
      if (pasteEl) pasteEl.addEventListener('input', () => { loadTestUserData = parseUserDataInput(pasteEl.value); updateUserDataCount(); });
      if (pasteEl) pasteEl.addEventListener('blur', () => { loadTestUserData = parseUserDataInput(pasteEl.value); updateUserDataCount(); });
      if (clearBtn) clearBtn.addEventListener('click', () => { loadTestUserData = []; if (pasteEl) pasteEl.value = ''; updateUserDataCount(); setStatus('User data cleared'); });
    })();

    function renderReport(report) {
      emptyState.style.display = 'none';
      reportContent.style.display = 'block';
      chartInstances.forEach(c => { try { c.destroy(); } catch (_) {} });
      chartInstances = [];

      const s = report.summary || {};
      const duration = (s && s.duration && typeof s.duration === 'object') ? s.duration : {};
      const runDate = report.startTime ? new Date(report.startTime).toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' }) : '–';
      const execText = report.totalCalls
        ? `Total <strong>${report.totalCalls}</strong> requests in <strong>${(report.totalTime / 1000).toFixed(2)}s</strong>. Success rate <strong>${s.successRate ?? '0%'}</strong>. Average response time <strong>${duration.avg ?? 0} ms</strong> (p95: ${duration.p95 ?? 0} ms). Throughput <strong>${s.throughputPerSec ?? 0} req/s</strong>.`
        : 'No requests run.';
      const errorEntries = s.errors && typeof s.errors === 'object' ? Object.entries(s.errors) : [];
      let statusCodes = s.statusCodeCounts && typeof s.statusCodeCounts === 'object' ? Object.entries(s.statusCodeCounts).sort((a, b) => Number(a[0]) - Number(b[0])) : [];
      if (!statusCodes.length && report.byRequest) {
        const codeCounts = {};
        Object.values(report.byRequest).filter(Boolean).forEach(reqData => {
          (reqData.results || []).filter(Boolean).forEach(r => {
            const c = r && r.statusCode != null ? r.statusCode : 0;
            codeCounts[c] = (codeCounts[c] || 0) + 1;
          });
        });
        statusCodes = Object.entries(codeCounts).sort((a, b) => Number(a[0]) - Number(b[0]));
      }

      const reportDate = report.startTime ? new Date(report.startTime).toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : '–';
      const failCount = s.failCount ?? 0;
      const findings = [];
      if (report.totalCalls) {
        if (failCount === 0) findings.push(`All ${report.totalCalls} requests completed successfully.`);
        else findings.push(`${failCount} request(s) failed out of ${report.totalCalls}. See Error breakdown for details.`);
        findings.push(`Success rate: ${s.successRate ?? '0%'}.`);
        findings.push(`Response time range: ${duration.min ?? 0} ms (min) to ${duration.max ?? 0} ms (max).`);
        if (duration.p95 > 0) findings.push(`95% of requests responded within ${duration.p95} ms.`);
        findings.push(`Throughput: ${s.throughputPerSec ?? 0} requests/second.`);
      }
      const findingsHtml = findings.length ? `<ul>${findings.map((f, i) => `<li class="${i === 0 && failCount > 0 ? 'fail' : ''}">${escapeHtml(f)}</li>`).join('')}</ul>` : '<p style="color:var(--textMuted);font-size:0.9rem;">No data.</p>';
      const reportMetaParts = [(report.type || 'single'), (report.durationSeconds ? report.durationSeconds + 's run' : (report.iterations ?? 1) + ' iteration(s)'), 'Concurrency ' + (report.concurrency ?? 1)];
      if (report.rampUpSeconds) reportMetaParts.push('Ramp-up ' + report.rampUpSeconds + 's');
      if (report.workers > 1) reportMetaParts.push('Workers ' + report.workers);
      if (report.delayBetweenRequestsMs) reportMetaParts.push('Delay ' + report.delayBetweenRequestsMs + 'ms');
      const slaBadge = report.sla && typeof report.sla.pass === 'boolean'
        ? `<span class="sla-badge ${report.sla.pass ? 'pass' : 'fail'}" title="SLA: ${report.sla.minSuccessRate ? 'Success rate ≥ ' + report.sla.minSuccessRate + '%' : ''} ${report.sla.maxP95Ms ? 'p95 ≤ ' + report.sla.maxP95Ms + 'ms' : ''}">SLA ${report.sla.pass ? 'PASS' : 'FAIL'}</span>`
        : '';
      const configDl = [
        ['Run at', runDate],
        ['Mode', (report.type || 'single')],
        ['Iterations', report.durationSeconds ? '–' : (report.iterations ?? 1)],
        ['Concurrency', report.concurrency ?? 1],
        ...(report.workers > 1 ? [['Workers', report.workers]] : []),
        ...(report.rampUpSeconds ? [['Ramp-up', report.rampUpSeconds + 's']] : []),
        ...(report.durationSeconds ? [['Run for', report.durationSeconds + 's']] : []),
        ...(report.delayBetweenRequestsMs ? [['Delay between requests', report.delayBetweenRequestsMs + 'ms']] : []),
        ['Total requests', report.totalCalls ?? 0],
        ['Total duration', (report.totalTime / 1000).toFixed(2) + 's'],
        ...(report.sla && (report.sla.minSuccessRate > 0 || report.sla.maxP95Ms > 0) ? [
          ['SLA result', (report.sla.pass ? 'PASS' : 'FAIL') + (report.sla.actualSuccessRate != null ? ' (success ' + report.sla.actualSuccessRate + '%, p95 ' + (report.sla.actualP95Ms ?? '–') + 'ms)' : '')],
        ] : []),
      ];
      let html = `
        <div class="report-cover">
          <div class="report-product">PostMeter</div>
          <div class="report-doc-title">API Load Test Report</div>
          <div class="report-doc-sub">Performance &amp; reliability assessment</div>
          <div class="report-date">${runDate}</div>
          <div class="report-meta" style="margin-top:12px;">${reportMetaParts.join(' · ')} ${slaBadge}</div>
        </div>
        <div class="report-section">
          <div class="executive-summary">
            <div class="exec-label">Executive summary</div>
            <p>${execText}</p>
            <p>This report presents key metrics, response time distribution, and per-endpoint results. Use the charts and table below for detailed analysis.</p>
          </div>
          <h3>Test configuration &amp; key findings</h3>
          <div class="report-detail-grid">
            <div class="report-config">
              <h4>Test configuration</h4>
              <dl>
                ${configDl.map(([dt, dd]) => `<dt>${escapeHtml(dt)}</dt><dd>${escapeHtml(String(dd))}</dd>`).join('')}
              </dl>
            </div>
            <div class="report-findings">
              <h4>Key findings</h4>
              ${findingsHtml}
            </div>
          </div>
          <h3>1. Key metrics</h3>
          <div class="stats-cards">
            <div class="stat-card"><div class="value">${report.totalCalls}</div><div class="label">Total requests</div></div>
            <div class="stat-card"><div class="value">${(report.totalTime / 1000).toFixed(2)}s</div><div class="label">Total time</div></div>
            <div class="stat-card"><div class="value">${s.successCount ?? 0}</div><div class="label">Success</div></div>
            <div class="stat-card danger"><div class="value">${s.failCount ?? 0}</div><div class="label">Failed</div></div>
            <div class="stat-card"><div class="value">${s.successRate ?? '0%'}</div><div class="label">Success rate</div></div>
            <div class="stat-card"><div class="value">${s.throughputPerSec ?? 0}</div><div class="label">Req/s</div></div>
            <div class="stat-card"><div class="value">${duration.min ?? 0} ms</div><div class="label">Min latency</div></div>
            <div class="stat-card"><div class="value">${duration.max ?? 0} ms</div><div class="label">Max latency</div></div>
            <div class="stat-card"><div class="value">${duration.avg ?? 0} ms</div><div class="label">Avg latency</div></div>
            <div class="stat-card"><div class="value">${duration.p50 ?? 0} ms</div><div class="label">p50 (median)</div></div>
            <div class="stat-card"><div class="value">${duration.p95 ?? 0} ms</div><div class="label">p95 latency</div></div>
            <div class="stat-card"><div class="value">${duration.p99 ?? 0} ms</div><div class="label">p99 latency</div></div>
          </div>
          <h3>2. Charts &amp; analysis</h3>
          <div class="charts-grid">
            <div class="chart-box"><h4>Success vs Failed</h4><canvas id="chartSuccessFail"></canvas></div>
            <div class="chart-box"><h4>Response time distribution</h4><canvas id="chartLatency"></canvas></div>
            <div class="chart-box"><h4>Response time over requests</h4><canvas id="chartTrend"></canvas></div>
            <div class="chart-box"><h4>Avg latency per API</h4><canvas id="chartPerApi"></canvas></div>
            <div class="chart-box"><h4>Status code distribution</h4><canvas id="chartStatusCodes"></canvas></div>
          </div>
          ${errorEntries.length ? `<div class="report-section" style="margin-top:24px;"><h3>Error breakdown</h3><ul class="error-breakdown-list">${errorEntries.map(([err, count]) => `<li>${escapeHtml(String(err))} <span class="count">(${count}×)</span></li>`).join('')}</ul></div>` : ''}
        </div>
        <div class="report-section">
          <h3>3. Per-request statistics</h3>
          <table class="per-request-table">
            <thead><tr><th>API</th><th>Path</th><th>Total</th><th>Success</th><th>Fail</th><th>Min (ms)</th><th>Avg (ms)</th><th>Max (ms)</th><th>p95 (ms)</th><th>Success %</th></tr></thead>
            <tbody>
      `;

      for (const [reqId, data] of Object.entries(report.byRequest || {})) {
        const st = (data && data.stats) ? data.stats : {};
        const d = (st && st.duration && typeof st.duration === 'object') ? st.duration : {};
        html += `<tr>
          <td>${escapeHtml(data.name || reqId)}</td>
          <td>${escapeHtml(data.path || '-')}</td>
          <td>${st.totalRequests ?? 0}</td>
          <td>${st.successCount ?? 0}</td>
          <td>${st.failCount ?? 0}</td>
          <td>${d.min ?? '-'}</td>
          <td>${d.avg ?? '-'}</td>
          <td>${d.max ?? '-'}</td>
          <td>${d.p95 ?? '-'}</td>
          <td>${st.successRate ?? '-'}</td>
        </tr>`;
      }
      html += `</tbody></table>
        <h3 style="margin-top:24px;">4. Sample responses (like JMeter)</h3>
        <p class="report-hint" style="font-size:0.8rem;color:var(--text-muted);margin-bottom:12px;">Har request ka response body + headers. Click "Show" to expand.</p>`;
      for (const [reqId, data] of Object.entries(report.byRequest || {})) {
        const samples = (data && data.results) ? data.results : [];
        const name = escapeHtml((data && data.name) || reqId);
        const sampleId = 'sample-' + reqId.replace(/[^a-z0-9-]/gi, '_');
        html += `<div class="response-samples-block" style="margin-bottom:20px;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;">
          <button type="button" class="response-samples-toggle" data-target="${sampleId}" style="width:100%;padding:12px 16px;text-align:left;background:var(--surface2);border:none;color:var(--text);font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:space-between;">
            <span>${name}</span>
            <span class="response-samples-count">${samples.length} response(s)</span>
          </button>
          <div id="${sampleId}" class="response-samples-list" style="display:none;padding:12px;background:var(--bg);max-height:400px;overflow:auto;">`;
        (samples.slice(0, 20)).forEach((s, idx) => {
          const status = s.statusCode ?? '-';
          const duration = (s.duration != null) ? s.duration + ' ms' : '-';
          const err = (s.error && String(s.error).trim()) ? escapeHtml(String(s.error).trim()) : '';
          const body = (s.bodyPreview && String(s.bodyPreview).trim()) ? escapeHtml(String(s.bodyPreview).trim()) : (err || '(no body)');
          const headers = s.responseHeaders && typeof s.responseHeaders === 'object' ? Object.entries(s.responseHeaders).map(([k, v]) => k + ': ' + v).join('\n') : '';
          const headerStr = headers ? escapeHtml(headers) : '';
          html += `<div class="response-sample-item" style="border:1px solid var(--border);border-radius:6px;margin-bottom:8px;overflow:hidden;">
            <div class="response-sample-head" style="padding:8px 12px;background:var(--surface2);display:flex;gap:16px;flex-wrap:wrap;align-items:center;">
              <span><strong>#${idx + 1}</strong></span>
              <span class="status-badge" style="padding:2px 8px;border-radius:4px;font-size:0.75rem;${status >= 200 && status < 300 ? 'background:var(--accent-muted);color:var(--accent);' : 'background:var(--danger-muted);color:var(--danger);'}">${status}</span>
              <span>${duration}</span>
              ${err ? `<span style="color:var(--danger);">${err}</span>` : ''}
            </div>
            <details style="font-size:0.8rem;">
              <summary style="padding:6px 12px;cursor:pointer;color:var(--accent);">Response body</summary>
              <pre style="margin:0;padding:12px;background:var(--surface);white-space:pre-wrap;word-break:break-all;max-height:200px;overflow:auto;">${body}</pre>
            </details>
            ${headerStr ? `<details style="font-size:0.8rem;"><summary style="padding:6px 12px;cursor:pointer;color:var(--accent);">Headers</summary><pre style="margin:0;padding:12px;background:var(--surface);white-space:pre-wrap;font-size:0.75rem;max-height:120px;overflow:auto;">${headerStr}</pre></details>` : ''}
          </div>`;
        });
        if (samples.length > 20) html += `<p style="font-size:0.8rem;color:var(--text-muted);padding:8px;">... and ${samples.length - 20} more. First 20 shown.</p>`;
        html += `</div></div>`;
      }
      html += `<div class="report-footer" style="margin-top:16px;">Generated by PostMeter · ${reportDate} · ${report.totalCalls || 0} requests</div>
      </div>`;
      reportContent.innerHTML = html;
      reportContent.querySelectorAll('.response-samples-toggle').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-target');
          const el = id ? document.getElementById(id) : null;
          if (el) { el.style.display = el.style.display === 'none' ? 'block' : 'none'; }
        });
      });

      const chartOpt = { responsive: true, maintainAspectRatio: true, plugins: { legend: { labels: { font: { size: 11 }, color: '#8b92a5', padding: 14 } } } };
      const gridOpt = { color: 'rgba(255,255,255,0.06)' };
      const ticksOpt = { color: '#8b92a5', font: { size: 10 } };

      const successFailEl = document.getElementById('chartSuccessFail');
      if (successFailEl) {
        const success = s.successCount ?? 0;
        const fail = s.failCount ?? 0;
        if (success + fail > 0) {
          chartInstances.push(new Chart(successFailEl, {
            type: 'doughnut',
            data: {
              labels: ['Success', 'Failed'],
              datasets: [{ data: [success, fail], backgroundColor: ['rgba(0,212,170,0.85)', 'rgba(239,68,68,0.85)'], borderWidth: 2, borderColor: 'var(--surface2)' }],
            },
            options: { ...chartOpt, cutout: '58%', plugins: { legend: { position: 'bottom' } } },
          }));
        }
      }

      const raw = s.rawDurations || [];
      const latencyEl = document.getElementById('chartLatency');
      if (raw.length && latencyEl) {
        const sorted = [...raw].sort((a, b) => a - b);
        const bins = Math.min(20, Math.max(5, Math.ceil(sorted.length / 10)));
        const step = (sorted[sorted.length - 1] - sorted[0]) / bins || 1;
        const counts = Array(bins).fill(0);
        sorted.forEach(v => {
          const i = Math.min(Math.floor((v - sorted[0]) / step), bins - 1);
          if (i >= 0) counts[i]++;
        });
        chartInstances.push(new Chart(latencyEl, {
          type: 'bar',
          data: {
            labels: counts.map((_, i) => Math.round(sorted[0] + step * (i + 0.5)) + ' ms'),
            datasets: [{ label: 'Requests', data: counts, backgroundColor: 'rgba(0,212,170,0.6)', borderColor: 'rgba(0,212,170,0.9)', borderWidth: 1 }],
          },
          options: { ...chartOpt, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: gridOpt, ticks: ticksOpt }, x: { grid: { display: false }, ticks: { ...ticksOpt, maxRotation: 45 } } } },
        }));
      }

      let allResults = report.allResultsInOrder || [];
      if (!allResults.length && (s.rawDurations || []).length) {
        allResults = s.rawDurations.map((duration, i) => ({ duration: typeof duration === 'number' ? duration : 0, success: true, statusCode: 200, name: `Request ${i + 1}` }));
      }
      const trendEl = document.getElementById('chartTrend');
      if (allResults.length && trendEl) {
        const labels = allResults.map((_, i) => (i + 1).toString());
        const data = allResults.map(r => (r && r.duration != null && typeof r.duration === 'number' ? r.duration : 0));
        chartInstances.push(new Chart(trendEl, {
          type: 'line',
          data: { labels, datasets: [{ label: 'Response time (ms)', data, borderColor: 'rgba(0,212,170,0.9)', backgroundColor: 'rgba(0,212,170,0.1)', fill: true, tension: 0.2 }] },
          options: { ...chartOpt, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: gridOpt, ticks: ticksOpt }, x: { grid: { display: false }, ticks: { ...ticksOpt, maxTicksLimit: 15 } } } },
        }));
      }

      const byRequest = report.byRequest || {};
      const perApiEntries = Object.entries(byRequest);
      const perApiNames = perApiEntries.map(([id, d]) => (d.name || id).toString().slice(0, 25));
      const perApiAvg = perApiEntries.map(([, d]) => (d && d.stats && d.stats.duration && (d.stats.duration.avg != null)) ? d.stats.duration.avg : 0);
      const perApiEl = document.getElementById('chartPerApi');
      if (perApiNames.length && perApiEl) {
        chartInstances.push(new Chart(perApiEl, {
          type: 'bar',
          data: { labels: perApiNames, datasets: [{ label: 'Avg latency (ms)', data: perApiAvg, backgroundColor: 'rgba(0,212,170,0.6)', borderColor: 'rgba(0,212,170,0.9)', borderWidth: 1 }] },
          options: { indexAxis: 'y', ...chartOpt, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, grid: gridOpt, ticks: ticksOpt }, y: { grid: { display: false }, ticks: { ...ticksOpt, font: { size: 10 } } } } },
        }));
      }

      const statusEl = document.getElementById('chartStatusCodes');
      if (statusCodes.length && statusEl) {
        chartInstances.push(new Chart(statusEl, {
          type: 'bar',
          data: { labels: statusCodes.map(([code]) => code === '0' ? 'Error' : code), datasets: [{ label: 'Count', data: statusCodes.map(([, c]) => c), backgroundColor: statusCodes.map(([code]) => code === '0' || Number(code) >= 400 ? 'rgba(255,82,82,0.6)' : 'rgba(0,212,170,0.6)'), borderWidth: 1 }] },
          options: { ...chartOpt, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: gridOpt, ticks: ticksOpt }, x: { grid: { display: false }, ticks: ticksOpt } } },
        }));
      }
    }

    exportBtn.addEventListener('click', () => {
      if (!lastReport) return;
      const blob = new Blob([JSON.stringify(lastReport, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `api-report-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
      setStatus('Report exported');
    });

    function getChartImageDataUrl(id) {
      const el = document.getElementById(id);
      if (!el || !el.width || !el.height) return '';
      try {
        return el.toDataURL('image/png');
      } catch (_) { return ''; }
    }

    function exportHtmlReport() {
      if (!lastReport || reportContent.style.display === 'none') return;
      const report = lastReport;
      const s = report.summary || {};
      const duration = (s && s.duration && typeof s.duration === 'object') ? s.duration : {};
      const runDate = report.startTime ? new Date(report.startTime).toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' }) : '–';
      const reportDate = report.startTime ? new Date(report.startTime).toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : '–';
      const img1 = getChartImageDataUrl('chartSuccessFail');
      const img2 = getChartImageDataUrl('chartLatency');
      const img3 = getChartImageDataUrl('chartTrend');
      const img4 = getChartImageDataUrl('chartPerApi');
      const img5 = getChartImageDataUrl('chartStatusCodes');
      const chartImg = (src, alt) => src ? `<img src="${src}" alt="${alt}" style="max-width:100%;height:auto;display:block;" />` : `<p style="color:#8b92a5;font-size:0.85rem;padding:20px;">No data</p>`;

      const execText = report.totalCalls
        ? `Total <strong>${report.totalCalls}</strong> requests in <strong>${(report.totalTime / 1000).toFixed(2)}s</strong>. Success rate <strong>${s.successRate ?? '0%'}</strong>. Average response time <strong>${duration.avg ?? 0} ms</strong> (p95: ${duration.p95 ?? 0} ms). Throughput <strong>${s.throughputPerSec ?? 0} req/s</strong>.`
        : 'No requests run.';

      let tableRows = '';
      for (const [reqId, data] of Object.entries(report.byRequest || {})) {
        const st = (data && data.stats) ? data.stats : {};
        const d = (st && st.duration && typeof st.duration === 'object') ? st.duration : {};
        const name = (data.name || reqId).replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        const path = (data.path || '-').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        tableRows += `<tr><td>${name}</td><td>${path}</td><td>${st.totalRequests ?? 0}</td><td>${st.successCount ?? 0}</td><td>${st.failCount ?? 0}</td><td>${d.min ?? '-'}</td><td>${d.avg ?? '-'}</td><td>${d.max ?? '-'}</td><td>${d.p95 ?? '-'}</td><td>${st.successRate ?? '-'}</td></tr>`;
      }

      const errorEntries = s.errors && typeof s.errors === 'object' ? Object.entries(s.errors) : [];
      const errorBlock = errorEntries.length
        ? `<div class="report-section"><h3>Error breakdown</h3><ul style="padding:20px 24px;margin:0;list-style:none;">${errorEntries.map(([err, count]) => `<li style="margin-bottom:8px;padding-left:12px;border-left:2px solid #ef4444;color:#ef4444;">${String(err).replace(/</g,'&lt;').replace(/>/g,'&gt;')} <span style="color:#8b92a5;margin-left:8px;">(${count}×)</span></li>`).join('')}</ul></div>`
        : '';

      const findings = [];
      if (report.totalCalls) {
        const fc = s.failCount ?? 0;
        if (fc === 0) findings.push(`All ${report.totalCalls} requests completed successfully.`);
        else findings.push(`${fc} request(s) failed. See Error breakdown.`);
        findings.push(`Success rate: ${s.successRate ?? '0%'}. Response time: ${duration.min ?? 0}–${duration.max ?? 0} ms. Throughput: ${s.throughputPerSec ?? 0} req/s.`);
      }
      const findingsList = findings.length ? findings.map(f => `<li style="margin-bottom:8px;">${String(f).replace(/</g,'&lt;').replace(/>/g,'&gt;')}</li>`).join('') : '<li>No data.</li>';

      const fullHtml = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>API Load Test Report - PostMeter</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 24px; background: #1a1d24; color: #e6e9ef; font-family: 'Outfit', sans-serif; font-size: 14px; line-height: 1.5; }
    .report { max-width: 1200px; margin: 0 auto; }
    .report-cover { background: linear-gradient(160deg, #252830 0%, #1a1d24 100%); border: 1px solid #2d3139; border-radius: 12px; padding: 40px 36px; margin-bottom: 28px; text-align: center; position: relative; }
    .report-cover::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #00d4aa, rgba(0,212,170,0.5)); border-radius: 12px 12px 0 0; }
    .report-cover .report-product { font-size: 0.7rem; letter-spacing: 0.2em; text-transform: uppercase; color: #8b92a5; margin-bottom: 8px; }
    .report-cover .report-doc-title { font-size: 1.75rem; font-weight: 700; color: #e6e9ef; letter-spacing: -0.02em; margin-bottom: 4px; }
    .report-cover .report-doc-sub { font-size: 0.9rem; color: #8b92a5; margin-bottom: 24px; }
    .report-cover .report-date { font-size: 0.8rem; color: #00d4aa; font-family: 'JetBrains Mono', monospace; }
    .report-cover .report-meta { margin-top: 12px; font-size: 0.8rem; color: #8b92a5; }
    .report-section { background: #252830; border: 1px solid #2d3139; border-radius: 12px; margin-bottom: 24px; overflow: hidden; }
    .report-section h3 { padding: 18px 24px; font-size: 0.8rem; font-weight: 600; border-bottom: 1px solid #2d3139; color: #8b92a5; text-transform: uppercase; letter-spacing: 0.08em; background: rgba(0,0,0,0.2); }
    .executive-summary { padding: 24px 28px; margin: 24px; border-radius: 10px; border: 1px solid #2d3139; border-left: 4px solid #00d4aa; background: rgba(0,212,170,0.06); }
    .executive-summary .exec-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: #00d4aa; font-weight: 600; margin-bottom: 10px; }
    .executive-summary p { margin: 0 0 10px 0; font-size: 0.95rem; line-height: 1.6; color: #e6e9ef; }
    .report-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; padding: 0 24px 24px; }
    @media (max-width: 700px) { .report-detail-grid { grid-template-columns: 1fr; } }
    .report-config, .report-findings { background: #1a1d24; border: 1px solid #2d3139; border-radius: 10px; padding: 18px 20px; }
    .report-config h4, .report-findings h4 { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.08em; color: #8b92a5; margin: 0 0 12px 0; }
    .report-config dt { font-size: 0.75rem; color: #8b92a5; margin-top: 10px; }
    .report-config dd { font-size: 0.9rem; font-family: 'JetBrains Mono', monospace; color: #e6e9ef; margin: 2px 0 0 0; }
    .report-findings ul { margin: 0; padding: 0; list-style: none; }
    .stats-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px; padding: 24px; }
    .stat-card { background: #1a1d24; border-radius: 10px; padding: 18px; border: 1px solid #2d3139; position: relative; border-left: 3px solid #00d4aa; }
    .stat-card.danger { border-left-color: #ef4444; }
    .stat-card .value { font-size: 1.6rem; font-weight: 700; color: #00d4aa; font-family: 'JetBrains Mono', monospace; }
    .stat-card.danger .value { color: #ef4444; }
    .stat-card .label { font-size: 0.7rem; color: #8b92a5; margin-top: 6px; text-transform: uppercase; letter-spacing: 0.04em; }
    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 24px; padding: 24px; }
    .chart-box { background: #1a1d24; border-radius: 10px; border: 1px solid #2d3139; padding: 20px; }
    .chart-box h4 { margin: 0 0 16px 0; font-size: 0.78rem; color: #8b92a5; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; padding-bottom: 10px; border-bottom: 1px solid #2d3139; }
    .per-request-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    .per-request-table th, .per-request-table td { padding: 14px 20px; text-align: left; border-bottom: 1px solid #2d3139; }
    .per-request-table thead { background: rgba(0,0,0,0.2); }
    .per-request-table th { color: #8b92a5; font-weight: 600; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.06em; }
    .per-request-table tbody tr:nth-child(even) { background: rgba(0,0,0,0.1); }
    .report-footer { text-align: center; padding: 20px 24px; font-size: 0.75rem; color: #8b92a5; border-top: 1px solid #2d3139; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="report">
    <div class="report-cover">
      <div class="report-product">PostMeter</div>
      <div class="report-doc-title">API Load Test Report</div>
      <div class="report-doc-sub">Performance &amp; reliability assessment</div>
      <div class="report-date">${runDate}</div>
      <div class="report-meta">${(report.type || 'single')} · ${report.iterations ?? 1} iteration(s) · Concurrency ${report.concurrency ?? 1}${report.rampUpSeconds ? ' · Ramp-up ' + report.rampUpSeconds + 's' : ''}${report.workers > 1 ? ' · Workers ' + report.workers : ''}</div>
    </div>
    <div class="report-section">
      <div class="executive-summary">
        <div class="exec-label">Executive summary</div>
        <p>${execText}</p>
        <p>This report presents key metrics, response time distribution, and per-endpoint results.</p>
      </div>
      <h3>Test configuration &amp; key findings</h3>
      <div class="report-detail-grid">
        <div class="report-config">
          <h4>Test configuration</h4>
          <dl><dt>Run at</dt><dd>${runDate}</dd><dt>Mode</dt><dd>${report.type || 'single'}</dd><dt>Iterations</dt><dd>${report.iterations ?? 1}</dd><dt>Concurrency</dt><dd>${report.concurrency ?? 1}</dd>${report.workers > 1 ? '<dt>Workers</dt><dd>' + report.workers + '</dd>' : ''}${report.rampUpSeconds ? '<dt>Ramp-up</dt><dd>' + report.rampUpSeconds + 's</dd>' : ''}<dt>Total requests</dt><dd>${report.totalCalls ?? 0}</dd><dt>Total duration</dt><dd>${(report.totalTime / 1000).toFixed(2)}s</dd></dl>
        </div>
        <div class="report-findings">
          <h4>Key findings</h4>
          <ul>${findingsList || '<li>No data.</li>'}</ul>
        </div>
      </div>
      <h3>1. Key metrics</h3>
      <div class="stats-cards">
        <div class="stat-card"><div class="value">${report.totalCalls}</div><div class="label">Total requests</div></div>
        <div class="stat-card"><div class="value">${(report.totalTime / 1000).toFixed(2)}s</div><div class="label">Total time</div></div>
        <div class="stat-card"><div class="value">${s.successCount ?? 0}</div><div class="label">Success</div></div>
        <div class="stat-card danger"><div class="value">${s.failCount ?? 0}</div><div class="label">Failed</div></div>
        <div class="stat-card"><div class="value">${s.successRate ?? '0%'}</div><div class="label">Success rate</div></div>
        <div class="stat-card"><div class="value">${s.throughputPerSec ?? 0}</div><div class="label">Req/s</div></div>
        <div class="stat-card"><div class="value">${duration.min ?? 0} ms</div><div class="label">Min latency</div></div>
        <div class="stat-card"><div class="value">${duration.max ?? 0} ms</div><div class="label">Max latency</div></div>
        <div class="stat-card"><div class="value">${duration.avg ?? 0} ms</div><div class="label">Avg latency</div></div>
        <div class="stat-card"><div class="value">${duration.p50 ?? 0} ms</div><div class="label">p50 (median)</div></div>
        <div class="stat-card"><div class="value">${duration.p95 ?? 0} ms</div><div class="label">p95 latency</div></div>
        <div class="stat-card"><div class="value">${duration.p99 ?? 0} ms</div><div class="label">p99 latency</div></div>
      </div>
      <h3>2. Charts &amp; analysis</h3>
      <div class="charts-grid">
        <div class="chart-box"><h4>Success vs Failed</h4>${chartImg(img1, 'Success vs Failed')}</div>
        <div class="chart-box"><h4>Response time distribution</h4>${chartImg(img2, 'Response time distribution')}</div>
        <div class="chart-box"><h4>Response time over requests</h4>${chartImg(img3, 'Response time trend')}</div>
        <div class="chart-box"><h4>Avg latency per API</h4>${chartImg(img4, 'Avg latency per API')}</div>
        <div class="chart-box"><h4>Status code distribution</h4>${chartImg(img5, 'Status code distribution')}</div>
      </div>
      ${errorBlock}
    </div>
    <div class="report-section">
      <h3>3. Per-request statistics</h3>
      <table class="per-request-table">
        <thead><tr><th>API</th><th>Path</th><th>Total</th><th>Success</th><th>Fail</th><th>Min (ms)</th><th>Avg (ms)</th><th>Max (ms)</th><th>p95 (ms)</th><th>Success %</th></tr></thead>
        <tbody>${tableRows}</tbody>
      </table>
      <div class="report-footer">Generated by PostMeter · ${reportDate} · ${report.totalCalls || 0} requests</div>
    </div>
  </div>
</body>
</html>`;

      const blob = new Blob([fullHtml], { type: 'text/html;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `PostMeter-report-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.html`;
      a.click();
      URL.revokeObjectURL(a.href);
      setStatus('HTML report downloaded');
    }

    document.getElementById('exportHtmlBtn').addEventListener('click', exportHtmlReport);
    document.getElementById('printReportBtn').addEventListener('click', () => {
      if (!lastReport || reportContent.style.display === 'none') return;
      window.print();
    });

    async function initAuth() {
      const guestEl = document.getElementById('authGuest');
      const loggedEl = document.getElementById('authLogged');
      const wsSelect = document.getElementById('workspaceSelect');
      const userEmailEl = document.getElementById('userEmail');
      try {
        const token = localStorage.getItem(AUTH_TOKEN_KEY);
        if (!token) { if (guestEl) guestEl.style.display = ''; if (loggedEl) loggedEl.style.display = 'none'; return; }
        const { res, data: me } = await fetchJson('/api/auth/me');
        if (!res.ok) { localStorage.removeItem(AUTH_TOKEN_KEY); if (guestEl) guestEl.style.display = ''; if (loggedEl) loggedEl.style.display = 'none'; return; }
        currentUser = me;
        const { data: wsData } = await fetchJson('/api/workspaces');
        workspacesList = (wsData && wsData.workspaces) ? wsData.workspaces : [];
        if (guestEl) guestEl.style.display = 'none';
        if (loggedEl) loggedEl.style.display = 'flex';
        if (userEmailEl) userEmailEl.textContent = currentUser.email || '';
        if (wsSelect) {
          skipWorkspaceChangeHandler = true;
          wsSelect.innerHTML = '<option value="">Personal workspace</option>' + workspacesList.map((w) => '<option value="' + w.id + '" ' + (w.role === 'owner' ? '' : '') + '>' + escapeHtml(w.name || 'Workspace') + (w.role === 'owner' ? ' (owner)' : '') + '</option>').join('');
          const saved = localStorage.getItem(WORKSPACE_KEY);
          const id = saved && workspacesList.some((w) => String(w.id) === saved) ? saved : (workspacesList[0] ? String(workspacesList[0].id) : '');
          currentWorkspaceId = id ? parseInt(id, 10) : null;
          if (wsSelect.value !== id) wsSelect.value = id || '';
          try { localStorage.setItem(WORKSPACE_KEY, id || ''); } catch (_) {}
          skipWorkspaceChangeHandler = false;
        }
        if (typeof updateDeleteWorkspaceButton === 'function') updateDeleteWorkspaceButton();
      } catch (_) {
        if (guestEl) guestEl.style.display = '';
        if (loggedEl) loggedEl.style.display = 'none';
      }
    }
    function updateAuthUI() {
      const loggedEl = document.getElementById('authLogged');
      const guestEl = document.getElementById('authGuest');
      if (currentUser) { if (guestEl) guestEl.style.display = 'none'; if (loggedEl) loggedEl.style.display = 'flex'; }
      else { if (loggedEl) loggedEl.style.display = 'none'; if (guestEl) guestEl.style.display = ''; }
    }
    (function bindAuthModals() {
      const overlay = document.getElementById('authModalOverlay');
      const loginPanel = document.getElementById('loginPanel');
      const registerPanel = document.getElementById('registerPanel');
      const loginError = document.getElementById('loginError');
      const registerError = document.getElementById('registerError');
      document.querySelectorAll('.modal-tab').forEach((tab) => {
        tab.addEventListener('click', () => {
          const t = tab.dataset.tab;
          document.querySelectorAll('.modal-tab').forEach((x) => x.classList.toggle('active', x.dataset.tab === t));
          if (loginPanel) loginPanel.style.display = t === 'login' ? 'block' : 'none';
          if (registerPanel) registerPanel.style.display = t === 'register' ? 'block' : 'none';
          if (loginError) loginError.textContent = '';
          if (registerError) registerError.textContent = '';
        });
      });
      document.getElementById('loginBtn').addEventListener('click', () => { if (overlay) overlay.style.display = 'flex'; });
      document.getElementById('registerBtn').addEventListener('click', () => { document.querySelector('.modal-tab[data-tab="register"]').click(); if (overlay) overlay.style.display = 'flex'; });
      document.getElementById('authModalClose').addEventListener('click', () => { if (overlay) overlay.style.display = 'none'; });
      overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.style.display = 'none'; });
      document.getElementById('loginSubmitBtn').addEventListener('click', async () => {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        if (loginError) loginError.textContent = '';
        if (!email || !password) { if (loginError) loginError.textContent = 'Email and password required'; return; }
        try {
          const { res, data } = await fetchJson('/api/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
          if (!res.ok) throw new Error(data.error || 'Login failed');
          localStorage.setItem(AUTH_TOKEN_KEY, data.token);
          currentUser = data.user;
          const { data: wsData } = await fetchJson('/api/workspaces');
          workspacesList = (wsData && wsData.workspaces) ? wsData.workspaces : [];
          const wsSelect = document.getElementById('workspaceSelect');
          if (wsSelect && workspacesList.length) {
            skipWorkspaceChangeHandler = true;
            wsSelect.innerHTML = '<option value="">Personal workspace</option>' + workspacesList.map((w) => '<option value="' + w.id + '">' + escapeHtml(w.name || 'Workspace') + (w.role === 'owner' ? ' (owner)' : '') + '</option>').join('');
            currentWorkspaceId = workspacesList[0].id;
            wsSelect.value = String(currentWorkspaceId);
            try { localStorage.setItem(WORKSPACE_KEY, String(currentWorkspaceId)); } catch (_) {}
            skipWorkspaceChangeHandler = false;
          }
          updateAuthUI();
          document.getElementById('userEmail').textContent = currentUser.email || '';
          overlay.style.display = 'none';
          await loadCollections();
          setStatus('Logged in. Data saved to your account.', 'success');
        } catch (e) {
          if (loginError) loginError.textContent = e.message || 'Login failed';
        }
      });
      document.getElementById('registerSubmitBtn').addEventListener('click', async () => {
        const name = document.getElementById('registerName').value.trim();
        const email = document.getElementById('registerEmail').value.trim();
        const password = document.getElementById('registerPassword').value;
        if (registerError) registerError.textContent = '';
        if (!email || !password) { if (registerError) registerError.textContent = 'Email and password required'; return; }
        if (password.length < 6) { if (registerError) registerError.textContent = 'Password min 6 characters'; return; }
        try {
          const { res, data } = await fetchJson('/api/auth/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password, name: name || undefined }) });
          if (!res.ok) throw new Error(data.error || 'Registration failed');
          localStorage.setItem(AUTH_TOKEN_KEY, data.token);
          currentUser = data.user;
          const { data: wsData } = await fetchJson('/api/workspaces');
          workspacesList = (wsData && wsData.workspaces) ? wsData.workspaces : [];
          const wsSelect = document.getElementById('workspaceSelect');
          if (wsSelect && workspacesList.length) {
            skipWorkspaceChangeHandler = true;
            wsSelect.innerHTML = '<option value="">Personal workspace</option>' + workspacesList.map((w) => '<option value="' + w.id + '">' + escapeHtml(w.name || 'Workspace') + (w.role === 'owner' ? ' (owner)' : '') + '</option>').join('');
            currentWorkspaceId = workspacesList[0].id;
            wsSelect.value = String(currentWorkspaceId);
            try { localStorage.setItem(WORKSPACE_KEY, String(currentWorkspaceId)); } catch (_) {}
            skipWorkspaceChangeHandler = false;
          }
          updateAuthUI();
          document.getElementById('userEmail').textContent = currentUser.email || '';
          overlay.style.display = 'none';
          await loadCollections();
          setStatus('Account created. Data saved to your workspace.', 'success');
        } catch (e) {
          if (registerError) registerError.textContent = e.message || 'Registration failed';
        }
      });
    })();
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem(AUTH_TOKEN_KEY);
      currentUser = null;
      currentWorkspaceId = null;
      workspacesList = [];
      updateAuthUI();
      loadCollections();
      setStatus('Logged out. Using local data.');
    });
    document.getElementById('workspaceSelect').addEventListener('change', function() {
      if (skipWorkspaceChangeHandler) return;
      const v = this.value;
      const nextId = v ? parseInt(v, 10) : null;
      if (nextId === currentWorkspaceId) return;
      currentWorkspaceId = nextId;
      try { localStorage.setItem(WORKSPACE_KEY, v || ''); } catch (_) {}
      loadCollections();
    });
    (function bindNewWorkspaceModal() {
      const overlay = document.getElementById('newWorkspaceModalOverlay');
      const nameInput = document.getElementById('newWorkspaceName');
      const errorEl = document.getElementById('newWorkspaceError');
      function hide() {
        if (overlay) overlay.style.display = 'none';
        if (errorEl) errorEl.textContent = '';
      }
      function show() {
        if (nameInput) { nameInput.value = ''; nameInput.focus(); }
        if (errorEl) errorEl.textContent = '';
        if (overlay) overlay.style.display = 'flex';
      }
      document.getElementById('addWorkspaceBtn').addEventListener('click', () => {
        if (!currentUser) { setStatus('Login to create a workspace', 'error'); return; }
        show();
      });
      document.getElementById('newWorkspaceCancelBtn').addEventListener('click', hide);
      document.getElementById('newWorkspaceModalClose').addEventListener('click', hide);
      overlay.addEventListener('click', (e) => { if (e.target === overlay) hide(); });
      if (nameInput) nameInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); document.getElementById('newWorkspaceCreateBtn').click(); }
      });
      document.getElementById('newWorkspaceCreateBtn').addEventListener('click', async () => {
        const raw = nameInput && nameInput.value ? nameInput.value.trim() : '';
        const name = raw || 'New Workspace';
        if (errorEl) errorEl.textContent = '';
        try {
          const { res, data } = await fetchJson('/api/workspaces', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
          if (!res.ok) throw new Error(data.error || 'Failed to create workspace');
          workspacesList.push({ ...data, role: 'owner' });
          const wsSelect = document.getElementById('workspaceSelect');
          if (wsSelect) {
            skipWorkspaceChangeHandler = true;
            wsSelect.innerHTML = '<option value="">Personal workspace</option>' + workspacesList.map((w) => '<option value="' + w.id + '">' + escapeHtml(w.name || 'Workspace') + (w.role === 'owner' ? ' (owner)' : '') + '</option>').join('');
            currentWorkspaceId = data.id;
            wsSelect.value = String(data.id);
            try { localStorage.setItem(WORKSPACE_KEY, String(currentWorkspaceId)); } catch (_) {}
            skipWorkspaceChangeHandler = false;
          }
          hide();
          await loadCollections();
          setStatus('Workspace "' + (data.name || name) + '" created – add a Collection or Request', 'success');
        } catch (e) {
          if (errorEl) errorEl.textContent = e.message || 'Failed';
          setStatus(e.message, 'error');
        }
      });
    })();
    (function bindShareModal() {
      const overlay = document.getElementById('shareModalOverlay');
      const listEl = document.getElementById('shareMembersList');
      const emailInput = document.getElementById('shareEmail');
      document.getElementById('shareWorkspaceBtn').addEventListener('click', async () => {
        if (!currentWorkspaceId) { setStatus('Select a workspace first', 'error'); return; }
        overlay.style.display = 'flex';
        listEl.innerHTML = 'Loading…';
        try {
          const { data } = await fetchJson('/api/workspaces/' + currentWorkspaceId + '/members');
          const members = (data && data.members) ? data.members : [];
          listEl.innerHTML = members.length ? members.map((m) => '<li><span>' + escapeHtml(m.email) + '</span> <span class="role">' + (m.role || 'member') + '</span></li>').join('') : '<li class="muted">No members yet</li>';
        } catch (_) {
          listEl.innerHTML = '<li class="muted">Failed to load</li>';
        }
      });
      document.getElementById('shareInviteBtn').addEventListener('click', async () => {
        const email = (emailInput && emailInput.value) ? emailInput.value.trim().toLowerCase() : '';
        if (!email) { setStatus('Enter email', 'error'); return; }
        try {
          const { res, data } = await fetchJson('/api/workspaces/' + currentWorkspaceId + '/members', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email }) });
          if (!res.ok) throw new Error(data.error || 'Invite failed');
          emailInput.value = '';
          const { data: d2 } = await fetchJson('/api/workspaces/' + currentWorkspaceId + '/members');
          const members = (d2 && d2.members) ? d2.members : [];
          listEl.innerHTML = members.map((m) => '<li><span>' + escapeHtml(m.email) + '</span> <span class="role">' + (m.role || 'member') + '</span></li>').join('');
          setStatus('Invited ' + email, 'success');
        } catch (e) {
          setStatus(e.message, 'error');
        }
      });
      document.getElementById('shareModalClose').addEventListener('click', () => { overlay.style.display = 'none'; });
      overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.style.display = 'none'; });
    })();
    function updateDeleteWorkspaceButton() {
      const btn = document.getElementById('deleteWorkspaceBtn');
      if (!btn) return;
      const isOwner = currentWorkspaceId != null && workspacesList.some((w) => w.id === currentWorkspaceId && w.role === 'owner');
      btn.style.display = currentUser && isOwner ? '' : 'none';
    }
    document.getElementById('deleteWorkspaceBtn').addEventListener('click', async () => {
      if (!currentUser || !currentWorkspaceId) return;
      const w = workspacesList.find((x) => x.id === currentWorkspaceId);
      if (!w || w.role !== 'owner') { setStatus('Only owner can delete this workspace', 'error'); return; }
      if (!confirm('Delete workspace "' + (w.name || '') + '" and all its collections? This cannot be undone.')) return;
      try {
        const { res, data } = await fetchJson('/api/workspaces/' + currentWorkspaceId, { method: 'DELETE' });
        if (!res.ok) throw new Error(data.error || 'Delete failed');
        workspacesList = workspacesList.filter((x) => x.id !== currentWorkspaceId);
        const wsSelect = document.getElementById('workspaceSelect');
        const next = workspacesList[0];
        if (wsSelect) {
          skipWorkspaceChangeHandler = true;
          wsSelect.innerHTML = '<option value="">Personal workspace</option>' + workspacesList.map((w) => '<option value="' + w.id + '">' + escapeHtml(w.name || 'Workspace') + (w.role === 'owner' ? ' (owner)' : '') + '</option>').join('');
          if (next) {
            currentWorkspaceId = next.id;
            wsSelect.value = String(next.id);
            try { localStorage.setItem(WORKSPACE_KEY, String(currentWorkspaceId)); } catch (_) {}
          } else {
            currentWorkspaceId = null;
            wsSelect.value = '';
          }
          skipWorkspaceChangeHandler = false;
        }
        updateDeleteWorkspaceButton();
        await loadCollections();
        setStatus(next ? 'Workspace deleted. Switched to ' + (next.name || '') : 'Workspace deleted.', 'success');
      } catch (e) {
        setStatus(e.message, 'error');
      }
    });

    loadSavedPrefs();
    (async function() {
      await initAuth();
      loadCollections();
    })();
  </script>
</body>
</html>
